<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RiseUp</title>
  <link rel="shortcut icon" href="rasmlar/dark.png" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter','system-ui','sans-serif'],
          },
          backgroundImage: {
            'grid': 'radial-gradient(circle at 1px 1px, rgba(148,163,184,0.18) 1px, transparent 0)',
          }
        }
      }
    }
  </script>
</head>

<body class="min-h-screen bg-slate-950 text-slate-50 font-sans antialiased">
  <!-- ‚≠ê GLOBAL DARK NEON BACKGROUND (task.html uslubida) -->
  <div class="pointer-events-none fixed inset-0 -z-30 bg-slate-950"></div>

  <div class="pointer-events-none fixed inset-0 -z-20 overflow-hidden">
    <div class="absolute -top-40 -left-10 h-80 w-80 rounded-full bg-indigo-500/35 blur-3xl"></div>
    <div class="absolute -bottom-40 -right-10 h-96 w-96 rounded-full bg-fuchsia-500/35 blur-3xl"></div>
    <div class="absolute inset-0 opacity-[0.07] bg-grid bg-[length:26px_26px]"></div>
  </div>

  <div class="pointer-events-none fixed inset-x-0 top-20 -z-10 flex justify-center">
    <div class="h-64 w-[650px] rounded-[999px] bg-gradient-to-r from-indigo-500/40 via-sky-400/40 to-fuchsia-400/40 blur-3xl opacity-70"></div>
  </div>
  <!-- ‚≠ê END BACKGROUND -->

  <div class="flex h-screen relative">
    
    <!-- Sidebar -->
    <aside
      id="sidebar"
      class="w-64 bg-slate-900/85 shadow-2xl shadow-slate-950/70 border-r border-slate-800 flex flex-col transition-all duration-300 ease-in-out flex-shrink-0 hidden"
      data-hidden-on-home="true"
    >
      
      <!-- Sidebar Header -->
      <div class="p-6 border-b border-slate-800/80">
        <div class="flex items-center justify-between gap-3">
          <div class="flex items-center gap-3 overflow-hidden">
            <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-sky-500 rounded-lg flex items-center justify-center flex-shrink-0 shadow-lg shadow-indigo-500/40">
              <img class="rounded-lg" src="rasmlar/darkrise.png" alt="">
            </div>
            <div id="logoText" class="whitespace-nowrap transition-opacity duration-300 opacity-100">
              <h1 id="welcomeText" class="text-lg font-bold text-slate-50">RiseUp</h1>
              <p id="logoSub" class="text-sm text-slate-400">Learning Platform</p>
            </div>
          </div>
          <button
            id="toggleBtn"
            onclick="toggleSidebar()"
            class="p-2 hover:bg-slate-800/80 rounded-lg transition-colors flex-shrink-0"
          >
            <svg class="w-5 h-5 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Navigation -->
      <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
        <!-- Home / Admin placeholder (modified): populated by JS based on localStorage.admin_session -->
        <div id="homeContainer"></div>
        <!-- Progress / Dashboard -->
        <a
          href="bolimlar/progress.html"
          target="contentFrame"
          class="flex items-center gap-3 px-4 py-3 text-slate-300 rounded-lg hover:bg-slate-800/80 hover:text-indigo-300 transition-all"
        >
          <span class="text-xl">üíª</span>
          <span class="nav-label">Kurslar</span>
        </a>

        <!-- Tasks -->
        <a
          onclick="navigateToPage('bolimlar/task.html')"
          class="cursor-pointer flex items-center gap-3 px-4 py-3 text-slate-300 rounded-lg hover:bg-slate-800/80 hover:text-indigo-300 transition-all"
        >
          <span class="text-xl">üìñ</span>
          <span class="nav-label">Vazifalar</span>
        </a>


        <!-- Statistics -->
        <a
          onclick="navigateToPage('bolimlar/statistic.html')"
          class="cursor-pointer flex items-center gap-3 px-4 py-3 text-slate-300 rounded-lg hover:bg-slate-800/80 hover:text-indigo-300 transition-all"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path d="M3 3v18h18" />
            <path d="M8 13h3v5H8zM13 9h3v9h-3zM18 5h3v13h-3z" />
          </svg>
          <span class="nav-label">Statistika</span>
        </a>

        <!-- Settings -->
        <a
          href="bolimlar/settings.html"
          target="contentFrame"
          class="flex items-center gap-3 px-4 py-3 text-slate-300 rounded-lg hover:bg-slate-800/80 hover:text-indigo-300 transition-all"
        >
          <span class="text-xl">‚öôÔ∏è</span>
          <span class="nav-label">Sozlamalar</span>
        </a>
      </nav>

      <!-- Footer -->
      <div class="p-4 border-t border-slate-800/80">
        <a
          onclick="logoutUser()"
          class="cursor-pointer flex items-center gap-3 px-4 py-3 text-slate-300 rounded-lg hover:bg-rose-900/40 hover:text-rose-300 transition-all"
        >
          <span class="text-xl">üö™</span>
          <span class="nav-label">Chiqish</span>
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto">
      <iframe
        name="contentFrame"
        src="bolimlar/progress.html"
        class="w-full h-screen border-none"
      ></iframe>
    </main>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const page = urlParams.get('page');
      const contentFrame = document.querySelector('iframe[name="contentFrame"]');
      const sidebar = document.getElementById('sidebar');

      // Helper to map simple page keys to iframe src
      function resolvePageFromParam(p) {
        if (!p) return null;
        if (p === 'task') return 'bolimlar/task.html';
        if (p === 'statistic') return 'bolimlar/statistic.html';
        // allow direct path stored in param or localStorage
        return p;
      }

      // Try URL param first, then last saved page, then default to progress
      const lastSaved = localStorage.getItem('lastContentPage');
      const resolvedFromParam = resolvePageFromParam(page);
      const srcToLoad = resolvedFromParam || lastSaved || 'bolimlar/progress.html';

      contentFrame.src = srcToLoad;
      // if it's a non-home view, ensure sidebar visible
      if (srcToLoad && (srcToLoad.includes('task.html') || srcToLoad.includes('statistic.html') || srcToLoad.includes('progress.html'))) {
        sidebar.classList.remove('hidden');
      }

      // set welcome name from localStorage (if available)
      if (typeof setWelcomeName === 'function') setWelcomeName();
    });

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const logoText = document.getElementById('logoText');
      const navLabels = document.querySelectorAll('.nav-label');
      const isCollapsed = sidebar.classList.contains('collapsed');

      if (isCollapsed) {
        sidebar.classList.remove('collapsed', 'w-20');
        sidebar.classList.add('w-64');
        logoText.classList.remove('hidden');
        navLabels.forEach(l => l.classList.remove('hidden'));
      } else {
        sidebar.classList.add('collapsed', 'w-20');
        sidebar.classList.remove('w-64');
        logoText.classList.add('hidden');
        navLabels.forEach(l => l.classList.add('hidden'));
      }
    }

    function navigateToPage(page) {
      const sidebar = document.getElementById('sidebar');
      const contentFrame = document.querySelector('iframe[name="contentFrame"]');
      
      sidebar.classList.remove('hidden');
      contentFrame.src = page;
      // persist the chosen page so a refresh will restore it
      try { localStorage.setItem('lastContentPage', page); } catch (err) { /* ignore */ }
    }

    function navigateToHome() {
      window.location.href = 'main.html';
    }

    // Display dynamic welcome text using stored username/email/fullName
    function setWelcomeName() {
      const welcomeEl = document.getElementById('welcomeText');
      if (!welcomeEl) return;

      // include fullName for compatibility with settings page
      const keys = ['fullName','username','user','name','displayName','display_name','email','adminEmail'];
      let found = null;
      for (const k of keys) {
        const v = localStorage.getItem(k);
        if (v) { found = v; break; }
      }

      if (found) {
        // if full name provided (contains space), use it; otherwise derive from email
        let name = found;
        if (found.includes('@')) name = found.split('@')[0];
        const pretty = name.charAt(0).toUpperCase() + name.slice(1);
        welcomeEl.textContent = 'Xush kelibsiz, ' + pretty;
        const sub = document.getElementById('logoSub');
        if (sub) sub.textContent = pretty;
      } else {
        welcomeEl.textContent = 'RiseUp';
        const sub = document.getElementById('logoSub');
        if (sub) sub.textContent = 'Learning Platform';
      }
    }

    // Listen for storage changes from iframe/settings and update greeting immediately
    window.addEventListener('storage', (e) => {
      // if no key provided (clear), or if relevant key changed, refresh welcome
      if (!e.key || ['fullName','username','user','name','displayName','display_name','email','adminEmail'].includes(e.key)) {
        setWelcomeName();
      }
    });

    document.querySelector('iframe[name="contentFrame"]').addEventListener('load', function() {
      const sidebar = document.getElementById('sidebar');
      const currentSrc = this.src;

      // Keep sidebar visible for known internal pages
      if (currentSrc.includes('progress.html') || currentSrc.includes('task.html') || currentSrc.includes('statistic.html')) {
        sidebar.classList.remove('hidden');
      }

      // Persist a compact relative path so refresh restores the same iframe
      try {
        if (currentSrc.includes('task.html')) localStorage.setItem('lastContentPage', 'bolimlar/task.html');
        else if (currentSrc.includes('statistic.html')) localStorage.setItem('lastContentPage', 'bolimlar/statistic.html');
        else if (currentSrc.includes('progress.html')) localStorage.setItem('lastContentPage', 'bolimlar/progress.html');
        else localStorage.setItem('lastContentPage', currentSrc);
      } catch (err) { /* ignore storage errors */ }
    });

    function logoutUser() {
      localStorage.removeItem('access');
      localStorage.removeItem('refresh');
      localStorage.removeItem('username');
      localStorage.removeItem('email');
      localStorage.removeItem('user');
      localStorage.removeItem('name');

      confirm("Chiqishni xohlaysizmi?");
      if(confirm){
        window.location.href = "login.html"; 
      } else {
        return;
      }
        
    }
    
    // MODIFIED: show Admin link instead of Home when admin_session exists; otherwise remove Home link
    (function manageHomeAdminLink(){
      try {
        const container = document.getElementById('homeContainer');
        if (!container) return;

        function render() {
          container.innerHTML = '';
          const isAdmin = localStorage.getItem('admin_session') === '1';
          if (isAdmin) {
            const a = document.createElement('a');
            a.href = 'admin/admin.html';
            a.target = 'contentFrame';
            a.className = 'flex items-center gap-3 px-4 py-3 text-slate-300 rounded-lg hover:bg-slate-800/80 hover:text-indigo-300 transition-all';
            a.innerHTML = '<span class="text-xl">üè†</span><span class="nav-label">Admin</span>';
            container.appendChild(a);
          } else {
            // no Home or Admin link should be visible for non-admin users per request
            container.innerHTML = '';
          }
        }

        render();
        window.addEventListener('storage', (e)=>{ if (e.key === 'admin_session') render(); });
      } catch (err) {
        console.warn('manageHomeAdminLink error', err);
      }
    })();
  </script>
</body>
</html>
