<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings Page</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter','system-ui','sans-serif'],
          },
          backgroundImage: {
            'grid': 'radial-gradient(circle at 1px 1px, rgba(148,163,184,0.18) 1px, transparent 0)',
          }
        }
      }
    }
  </script>
<style>
      html, body { overflow-x: hidden; }
      img, video, iframe { max-width: 100%; }
</style>
  <link rel="stylesheet" href="base.css" />
</head>

<body class="min-h-screen bg-slate-950 text-slate-50 font-sans antialiased">

  <!-- GLOBAL COSMIC BACKGROUND (main/progress/task bilan bir xil stil) -->
  <div class="pointer-events-none fixed inset-0 -z-30 bg-slate-950"></div>

  <div class="pointer-events-none fixed inset-0 -z-20 overflow-hidden">
    <div class="absolute -top-40 -left-10 h-80 w-80 rounded-full bg-indigo-500/35 blur-3xl"></div>
    <div class="absolute -bottom-40 -right-10 h-96 w-96 rounded-full bg-fuchsia-500/35 blur-3xl"></div>
    <div class="absolute inset-0 opacity-[0.07] bg-grid bg-[length:26px_26px]"></div>
  </div>

  <div class="pointer-events-none fixed inset-x-0 top-24 -z-10 flex justify-center">
    <div class="h-64 w-[650px] rounded-[999px] bg-gradient-to-r from-indigo-500/40 via-sky-400/40 to-fuchsia-400/40 blur-3xl opacity-70"></div>
  </div>
  <!-- END BACKGROUND -->

  <!-- MAIN CARD -->
  <div class="max-w-3xl mx-auto mt-10 rounded-2xl border border-slate-800/70 bg-slate-900/80 backdrop-blur-xl shadow-2xl shadow-slate-950/80 px-6 py-7 md:px-8 md:py-8">
    <h1 class="text-2xl md:text-3xl font-bold text-slate-50 mb-2 tracking-tight">
      Profil sozlamalari
    </h1>
    <p class="text-sm md:text-base text-slate-400 mb-6">
      Shaxsiy ma'lumotlaringizni va xavfsizlik sozlamalaringizni boshqaring
    </p>

    <!-- PROFILE PHOTO -->
    <div class="mb-8">
      <label class="block text-sm font-semibold text-slate-200 mb-2">
        Profil rasmi
      </label>

      <div class="flex flex-col sm:flex-row sm:items-center gap-4">
        <img
          id="profileImg"
          src="https://api.dicebear.com/7.x/bottts/svg?seed=RiseUp"
          class="w-20 h-20 rounded-xl object-cover border border-slate-700 bg-slate-900 shadow-lg shadow-slate-950/60"
          alt="Profile avatar"
        />

        <div class="flex flex-col gap-2">
          <label
            class="cursor-pointer bg-slate-800/80 border border-slate-700 text-slate-100 px-4 py-2 rounded-lg font-medium text-sm hover:bg-slate-700/80 transition-colors inline-flex items-center gap-2"
          >
            <span>Yangi rasm yuklash</span>
            <input type="file" id="uploadPhoto" class="hidden" accept="image/*">
          </label>

          <button
            id="removePhoto"
            class="text-rose-300 flex items-center gap-1 text-xs font-semibold hover:text-rose-200 transition-colors"
          >
            üóë Olib tashlash
          </button>
        </div>
      </div>
    </div>

    <!-- FULL NAME -->
    <div class="mb-10">
      <label class="block text-sm font-semibold text-slate-200 mb-2">
        Nickname (ism)
      </label>
      <input
        id="fullName"
        type="text"
        class="w-full border border-slate-700 rounded-lg px-4 py-2.5 bg-slate-900/80 text-slate-100 placeholder:text-slate-500 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/70 focus:border-indigo-400"
        placeholder="Your Name"
      >
    </div>

    <!-- PASSWORD SECTION -->
    <div class="mt-10 border-t border-slate-800 pt-8">
      <h2 class="text-xl md:text-2xl font-bold text-slate-50 mb-3">
        Parol & Xavfsizlik
      </h2>
      <p class="text-sm text-slate-400 mb-6">
        Parolingizni yangilash yoki hisobingiz xavfsizlik sozlamalarini boshqaring
      </p>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold text-slate-200 mb-2">
            Yangi parol
          </label>
          <input
            id="newPass"
            type="password"
            class="w-full border border-slate-700 rounded-lg px-4 py-2.5 bg-slate-900/80 text-slate-100 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/70 focus:border-indigo-400"
          >
        </div>

        <div>
          <label class="block text-sm font-semibold text-slate-200 mb-2">
            Parolni tasdiqlang
          </label>
          <input
            id="confirmPass"
            type="password"
            class="w-full border border-slate-700 rounded-lg px-4 py-2.5 bg-slate-900/80 text-slate-100 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/70 focus:border-indigo-400"
          >
        </div>
      </div>

      <button
        id="updatePassBtn"
        class="mt-5 bg-slate-100 text-slate-900 px-6 py-2 rounded-lg text-sm font-semibold hover:bg-white transition-colors"
      >
        Parolni yangilash
      </button>
    </div>

    <button
      id="saveAll"
      class="mt-10 bg-gradient-to-r from-indigo-500 via-purple-500 to-fuchsia-500 text-white px-8 py-3 rounded-xl font-semibold text-base hover:from-indigo-400 hover:via-purple-400 hover:to-fuchsia-400 shadow-lg shadow-fuchsia-500/40 transition-colors w-full sm:w-auto"
    >
      Saqlash
    </button>
  </div>

  <!-- TOAST -->
  <div
    id="toast"
    class="hidden fixed bottom-5 right-5 bg-slate-900/95 border border-slate-700 text-slate-100 px-5 py-3 rounded-lg shadow-2xl shadow-slate-950/80 text-sm"
  >
    Muvaffaqiyatli saqlandi ‚úÖ
  </div>

  <!-- JAVASCRIPT (mantiq o‚Äòsha-o‚Äòsha, faqat rasm URL‚Äôlari yangilangan) -->
<script>
const API = "https://api.riseuply.uz";
const token = localStorage.getItem("access"); // –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π —Ç–æ–∫–µ–Ω

function authHeader() {
    return { "Authorization": `Bearer ${token}` };
}

function showToast(message) {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.classList.remove("hidden");
    setTimeout(() => toast.classList.add("hidden"), 2500);
}

// Helper to resolve avatar URL (prefix with API if relative)
function resolveAvatarUrl(url) {
  if (!url) return url;
  if (url.startsWith('http://') || url.startsWith('https://') || url.startsWith('//')) return url;
  // ensure no double slash when joining
  if (API.endsWith('/') && url.startsWith('/')) return API.slice(0, -1) + url;
  if (!API.endsWith('/') && !url.startsWith('/')) return API + '/' + url;
  return API + url;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è
async function loadSettings() {
    try {
        const res = await fetch(`${API}/api/settings/profile/`, {
            method: "GET",
            headers: authHeader()
        });

        if (!res.ok) {
            console.error("Avtorizatsiya xatosi:", res.status);
            return;
        }

        const data = await res.json();
        const fullNameInput = document.getElementById("fullName");
        const profileImg = document.getElementById("profileImg");

        fullNameInput.value = data.first_name || "";
        profileImg.src = data.avatar
          ? resolveAvatarUrl(data.avatar)
          : `https://api.dicebear.com/7.x/bottts/svg?seed=${localStorage.getItem("username") || "User"}`;

    } catch (e) {
        console.error("Profil yuklashda xatolik:", e);
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏
document.getElementById("saveAll").addEventListener("click", async () => {
    const fullName = document.getElementById("fullName").value.trim();
    if (!fullName) return showToast("Ismni kiriting");

    try {
        const res = await fetch(`${API}/api/settings/name/`, {
            method: "POST",
            headers: {
                ...authHeader(),
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ name: fullName })
        });

        const data = await res.json();
        if (data.success) showToast("Ism saqlandi");
        else showToast("Ism saqlashdagi xatolik");

    } catch (e) {
        console.error("Ism saqlashda xatolik:", e);
    }
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞
document.getElementById("uploadPhoto").addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const form = new FormData();
    form.append("avatar", file);

    try {
        const res = await fetch(`${API}/api/settings/avatar/`, {
            method: "POST",
            headers: authHeader(),
            body: form
        });

        const data = await res.json();
        if (data.success) {
          // use resolved URL and add cache-buster so browser loads the new file
          const resolved = resolveAvatarUrl(data.avatar);
          const sep = resolved.includes('?') ? '&' : '?';
          document.getElementById("profileImg").src = resolved + sep + new Date().getTime();
          showToast("Avatar yangilandi");
        }

    } catch (e) {
        console.error("Avatar yuklashda xatolik:", e);
    }
});

// –£–¥–∞–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞
document.getElementById("removePhoto").addEventListener("click", async () => {
    try {
        const res = await fetch(`${API}/api/settings/avatar/remove/`, {
            method: "POST",
            headers: authHeader()
        });

        const data = await res.json();
        if (data.success) {
            document.getElementById("profileImg").src = `https://api.dicebear.com/7.x/bottts/svg?seed=${localStorage.getItem("username") || "User"}`;
            showToast("Avatar o'chirildi");
        }

    } catch (e) {
        console.error("Avatar o'chirishda xatolik:", e);
    }
});

// –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è
document.getElementById("updatePassBtn").addEventListener("click", async () => {
    const oldPass = prompt("Hozirgi parolingizni kiriting:");
    if (!oldPass) return;

    const newPassVal = document.getElementById("newPass").value;
    const confPassVal = document.getElementById("confirmPass").value;

    if (newPassVal !== confPassVal) return showToast("Parol mos emas");
    if (!newPassVal) return showToast("Yangi parolni kiriting");

    try {
        const res = await fetch(`${API}/api/settings/password/`, {
            method: "POST",
            headers: {
                ...authHeader(),
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                old_password: oldPass,
                new_password: newPassVal,
                confirm_password: confPassVal
            })
        });

        const data = await res.json();
        if (data.success) {
            showToast("–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω");
            document.getElementById("newPass").value = "";
            document.getElementById("confirmPass").value = "";
        } else {
            showToast(data.error || "Error changing password");
        }

    } catch (e) {
        console.error("Error changing password:", e);
    }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
window.addEventListener("DOMContentLoaded", loadSettings);
</script>



  <script src="base.js"></script>
</body>
</html>
