<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kurslar ‚Ä¢ RiseUp</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ["Inter", "system-ui", "sans-serif"] },
            backgroundImage: {
              grid: "radial-gradient(circle at 1px 1px, rgba(148,163,184,0.18) 1px, transparent 0)",
            },
          },
        },
      };
    </script>

    <style>
      * {
        scrollbar-width: thin;
        scrollbar-color: rgba(148, 163, 184, 0.35) rgba(15, 23, 42, 0.25);
      }
      *::-webkit-scrollbar {
        height: 10px;
        width: 10px;
      }
      *::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.35);
        border-radius: 999px;
      }
      *::-webkit-scrollbar-track {
        background: rgba(15, 23, 42, 0.25);
        border-radius: 999px;
      }
    </style>
  </head>

  <body
    class="min-h-screen bg-slate-950 text-slate-50 font-sans antialiased selection:bg-sky-500/30 selection:text-white"
  >
    <!-- FON -->
    <div class="pointer-events-none fixed inset-0 -z-30 bg-slate-950"></div>
    <div class="pointer-events-none fixed inset-0 -z-20 overflow-hidden">
      <div
        class="absolute -top-32 -left-10 h-72 w-72 rounded-full bg-indigo-500/30 blur-3xl"
      ></div>
      <div
        class="absolute -bottom-40 -right-10 h-80 w-80 rounded-full bg-fuchsia-500/30 blur-3xl"
      ></div>
      <div
        class="absolute inset-0 opacity-[0.08] bg-grid bg-[length:24px_24px]"
      ></div>
    </div>
    <div
      class="pointer-events-none fixed inset-x-0 top-24 -z-10 flex justify-center"
    >
      <div
        class="h-64 w-[720px] rounded-[999px] bg-gradient-to-r from-indigo-500/40 via-sky-400/40 to-fuchsia-500/40 blur-3xl opacity-80"
      ></div>
    </div>

    <div class="relative p-5 md:p-8">
      <div class="max-w-7xl mx-auto space-y-6">
        <!-- HEADER -->
        <header
          class="flex flex-col md:flex-row md:items-center md:justify-between gap-4"
        >
          <div class="space-y-1">
            <div class="flex items-center gap-3">
              <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">
                Kurslar
              </h1>
              <span
                id="userNameLabel"
                class="text-base md:text-lg text-slate-300"
              ></span>
            </div>
            <p class="text-sm text-slate-400">
              Yo‚Äònalishni tanlang, darslarni ko‚Äòring va progressni saqlang.
            </p>
          </div>

          <div class="flex items-center gap-2">
            <button
              id="btnBoshSahifa"
              class="inline-flex items-center gap-2 rounded-2xl border border-slate-700/80 bg-slate-900/60 px-4 py-2.5 text-sm font-semibold text-slate-200 hover:bg-slate-800/60 transition"
            >
              <span class="text-lg">üè†</span> Bosh sahifa
            </button>

            <button
              id="btnOrqaga"
              class="inline-flex items-center gap-2 rounded-2xl border border-sky-400/60 bg-slate-900/60 px-4 py-2.5 text-sm font-semibold text-sky-200 hover:bg-sky-500/10 hover:border-sky-300 transition"
            >
              <span class="text-lg">‚¨ÖÔ∏è</span> Orqaga
            </button>
          </div>
        </header>

        <!-- STATISTIKA -->
        <section class="grid grid-cols-1 lg:grid-cols-4 gap-5">
          <div
            class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-3 gap-4 lg:col-span-4"
          >
            <div
              class="bg-slate-900/80 border border-slate-700/80 rounded-2xl p-5 shadow-lg shadow-slate-950/70 backdrop-blur-xl flex items-center justify-between"
            >
              <div>
                <p class="text-sm text-slate-300/90 mb-1">Yo'nalishlar soni</p>
                <p
                  class="text-3xl md:text-4xl font-extrabold text-sky-300 leading-none"
                  id="jamiYonalishlar"
                >
                  0
                </p>
                <p class="text-xs md:text-sm text-slate-400 mt-2">
                  Jami yo'nalish
                </p>
              </div>
              <div
                class="h-12 w-12 rounded-2xl bg-sky-500/20 border border-sky-400/70 flex items-center justify-center text-2xl"
              >
                üß≠
              </div>
            </div>

            <div
              class="bg-slate-900/80 border border-slate-700/80 rounded-2xl p-5 shadow-lg shadow-slate-950/70 backdrop-blur-xl flex items-center justify-between"
            >
              <div>
                <p class="text-sm text-slate-300/90 mb-1">Darslar soni</p>
                <p
                  class="text-3xl md:text-4xl font-extrabold text-emerald-300 leading-none"
                  id="jamiDarslar"
                >
                  0
                </p>
                <p class="text-xs md:text-sm text-slate-400 mt-2">Jami dars</p>
              </div>
              <div
                class="h-12 w-12 rounded-2xl bg-emerald-500/20 border border-emerald-400/70 flex items-center justify-center text-2xl"
              >
                ‚úÖ
              </div>
            </div>

            <div
              class="bg-slate-900/80 border border-slate-700/80 rounded-2xl p-5 shadow-lg shadow-slate-950/70 backdrop-blur-xl flex items-center justify-between"
            >
              <div class="min-w-0">
                <p class="text-sm text-slate-300/90 mb-1">Oxirgi ochilgan</p>
                <p
                  class="text-xl md:text-2xl font-extrabold text-fuchsia-300 truncate max-w-[240px]"
                  id="oxirgiOchildi"
                >
                  ‚Äî
                </p>
                <p class="text-xs md:text-sm text-slate-400 mt-2">
                  Oxirgi dars
                </p>
              </div>
              <div
                class="h-12 w-12 rounded-2xl bg-fuchsia-500/20 border border-fuchsia-400/70 flex items-center justify-center text-2xl"
              >
                üïí
              </div>
            </div>
          </div>
        </section>

        <main class="space-y-6">
          <!-- 1) YO'NALISHLAR -->
          <section id="viewYonalishlar" class="space-y-4">
            <div class="space-y-3">
              <div
                class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3"
              >
                <div class="space-y-1">
                  <p class="text-sm font-semibold text-slate-200">
                    Yo‚Äònalishlar
                  </p>
                  <p class="text-sm text-slate-400">
                    Filter yoki qidiruv orqali tez toping.
                  </p>
                </div>

                <input
                  id="qidiruvInput"
                  placeholder="Yo'nalish qidirish..."
                  class="w-full sm:w-80 rounded-2xl border border-slate-700/80 bg-slate-900/70 px-4 py-3 text-sm text-slate-100 outline-none placeholder:text-slate-500 hover:border-sky-400/60 transition"
                />
              </div>

              <div id="filterBar" class="flex flex-wrap gap-2"></div>
            </div>

            <div
              id="yonalishlarGrid"
              class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5"
            ></div>
          </section>

          <!-- 2) YO'NALISH ICHIDAGI DARSLAR -->
          <section id="viewDarslar" class="hidden space-y-4">
            <div class="flex items-start justify-between gap-4">
              <div class="space-y-1">
                <p class="text-xs text-slate-400 uppercase tracking-[0.16em]">
                  Yo'nalish
                </p>
                <h2
                  id="yonalishTitle"
                  class="text-2xl md:text-3xl font-extrabold text-white"
                >
                  ‚Äî
                </h2>
                <p
                  id="yonalishDesc"
                  class="text-sm md:text-base text-slate-300 max-w-3xl"
                >
                  ‚Äî
                </p>
              </div>

              <div class="flex items-center gap-2">
                <span class="text-sm text-slate-400">Darslar:</span>
                <span
                  id="yonalishCount"
                  class="text-sm font-extrabold text-sky-300"
                  >0</span
                >
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-5 items-start">
              <div class="lg:col-span-2 space-y-3" id="darslarList"></div>

              <aside
                class="bg-slate-900/70 border border-slate-700/80 rounded-2xl p-5 shadow-lg shadow-slate-950/80 backdrop-blur-xl space-y-4"
              >
                <div class="flex items-center justify-between">
                  <p class="text-base font-extrabold text-white">Tezkor</p>
                  <span class="text-xl">‚ö°</span>
                </div>

                <button
                  id="btnBirinchiDars"
                  class="w-full bg-gradient-to-r from-sky-500 to-sky-600 text-slate-950 font-extrabold py-3 rounded-2xl text-sm hover:from-sky-400 hover:to-sky-500 transition-all duration-150 shadow shadow-sky-500/40"
                >
                  Davom ettirish ‚ñ∂Ô∏è
                </button>

                <div
                  class="pt-3 border-t border-slate-700/60 text-sm text-slate-300 space-y-1"
                >
                  <p class="text-slate-400">Maslahat:</p>
                  <p>
                    Ko‚Äòrib bo‚Äòlgach darsni ‚Äú‚úÖ Ko‚Äòrildi‚Äù deb belgilang ‚Äî
                    progress saqlanadi.
                  </p>
                </div>
              </aside>
            </div>
          </section>

          <!-- 3) PLAYER -->
          <section id="viewPlayer" class="hidden space-y-4">
            <div
              class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3"
            >
              <div class="space-y-1 min-w-0">
                <p
                  class="text-xs text-slate-400 uppercase tracking-[0.16em]"
                  id="playerBreadcrumb"
                >
                  ‚Äî
                </p>
                <h2
                  id="darsTitle"
                  class="text-2xl md:text-3xl font-extrabold text-white truncate"
                >
                  ‚Äî
                </h2>
                <p id="darsMeta" class="text-sm md:text-base text-slate-300">
                  ‚Äî
                </p>
              </div>

              <div class="flex items-center gap-2">
                <button
                  id="btnOldingi"
                  class="inline-flex items-center gap-2 rounded-2xl border border-slate-700/80 bg-slate-900/60 px-4 py-2.5 text-sm font-semibold text-slate-200 hover:bg-slate-800/60 transition disabled:opacity-40 disabled:hover:bg-slate-900/60"
                >
                  ‚¨ÖÔ∏è Oldingi
                </button>
                <button
                  id="btnKeyingi"
                  class="inline-flex items-center gap-2 rounded-2xl border border-emerald-400/60 bg-slate-900/60 px-4 py-2.5 text-sm font-semibold text-emerald-200 hover:bg-emerald-500/10 hover:border-emerald-300 transition disabled:opacity-40 disabled:hover:bg-slate-900/60 disabled:hover:border-emerald-400/60"
                >
                  Keyingi ‚û°Ô∏è
                </button>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-5 items-start">
              <!-- SIDEBAR -->
              <aside
                class="lg:col-span-4 bg-slate-900/70 border border-slate-700/80 rounded-2xl shadow-lg shadow-slate-950/80 backdrop-blur-xl overflow-hidden"
              >
                <div
                  class="p-4 border-b border-slate-700/60 flex items-center justify-between"
                >
                  <div class="space-y-0.5 min-w-0">
                    <p
                      class="text-xs text-slate-400 uppercase tracking-[0.16em]"
                    >
                      Darslar
                    </p>
                    <p
                      id="sidebarYonalishTitle"
                      class="text-base font-extrabold text-white truncate"
                    >
                      ‚Äî
                    </p>
                  </div>
                  <span class="text-xl">üìö</span>
                </div>

                <div class="p-3">
                  <input
                    id="darsQidiruv"
                    placeholder="Dars qidirish..."
                    class="w-full rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 text-sm text-slate-100 outline-none placeholder:text-slate-500 hover:border-sky-400/60 transition"
                  />
                </div>

                <div
                  id="sidebarDarslar"
                  class="px-3 pb-3 space-y-2 max-h-[560px] overflow-auto"
                ></div>
              </aside>

              <!-- VIDEO + INFO -->
              <div class="lg:col-span-8 space-y-5">
                <div
                  class="bg-slate-900/70 border border-slate-700/80 rounded-2xl overflow-hidden shadow-lg shadow-slate-950/80 backdrop-blur-xl"
                >
                  <div
                    class="p-4 border-b border-slate-700/60 flex items-center justify-between"
                  >
                    <p class="text-base md:text-lg font-extrabold text-white">
                      Dars videosi
                    </p>
                  </div>

                  <div class="aspect-video bg-black/40">
                    <video
                      id="videoPlayer"
                      class="w-full h-full hidden"
                      controls
                      playsinline
                    ></video>
                    <iframe
                      id="ytFrame"
                      class="w-full h-full"
                      src=""
                      title="YouTube video player"
                      frameborder="0"
                      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                      allowfullscreen
                    ></iframe>
                  </div>

                  <div
                    class="p-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3"
                  >
                    <div class="text-sm text-slate-300">
                      <span class="text-slate-400">Maslahat:</span> ko‚Äòrib
                      bo‚Äòlgach ‚ÄúKo‚Äòrildi‚Äù deb belgilang.
                    </div>
                    <button
                      id="btnKorildi"
                      class="inline-flex items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-emerald-500 to-teal-500 px-5 py-3 text-sm font-extrabold text-slate-950 hover:from-emerald-400 hover:to-teal-400 transition shadow shadow-emerald-500/40"
                    >
                      ‚úÖ Ko'rildi deb belgilash
                    </button>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                  <div
                    class="bg-slate-900/70 border border-slate-700/80 rounded-2xl p-5 shadow-lg shadow-slate-950/80 backdrop-blur-xl"
                  >
                    <div class="flex items-center justify-between mb-3">
                      <p class="text-base font-extrabold text-white">
                        Nimani o'rganasiz
                      </p>
                      <span class="text-xl">üß†</span>
                    </div>
                    <ul
                      id="darsBullets"
                      class="text-sm text-slate-200 space-y-2 list-disc pl-5"
                    ></ul>
                  </div>

                  <div
                    class="bg-slate-900/70 border border-slate-700/80 rounded-2xl p-5 shadow-lg shadow-slate-950/80 backdrop-blur-xl"
                  >
                    <div class="flex items-center justify-between mb-3">
                      <p class="text-base font-extrabold text-white">
                        Mini topshiriq
                      </p>
                      <span class="text-xl">üß©</span>
                    </div>
                    <div
                      id="darsTask"
                      class="text-sm text-slate-100 bg-slate-950/40 border border-slate-700/60 rounded-2xl p-4"
                    ></div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>

    <!-- TOAST -->
    <div
      id="toastWrap"
      class="fixed bottom-5 left-1/2 -translate-x-1/2 z-[9999] hidden"
    >
      <div
        class="rounded-2xl border border-slate-700/70 bg-slate-900/80 px-4 py-3 shadow-lg shadow-slate-950/80 backdrop-blur-xl"
      >
        <p id="toastText" class="text-sm text-slate-100"></p>
      </div>
    </div>

    <script>
      // =========================
      // CONFIG
      // =========================
      const isLocal =
        location.hostname === "127.0.0.1" || location.hostname === "localhost";
      const API_ORIGIN = isLocal
        ? "http://127.0.0.1:8000"
        : "https://riseup-back-production.up.railway.app";
      const API_BASE = `${API_ORIGIN}/api`;
      const $ = (id) => document.getElementById(id);

      const FILTERS = [
        { key: "all", label: "Hammasi" },
        { key: "fullstack", label: "Full-stack" },
        { key: "frontend", label: "Frontend" },
        { key: "backend", label: "Backend" },
        { key: "math", label: "Matematika" },
        { key: "english", label: "Ingliz tili" },
        { key: "ai", label: "AI" },
        { key: "devops", label: "DevOps" },
        { key: "amaliyot", label: "Amaliyot" },
      ];

      let DATA = { directions: [] };
      let activeFilter = "all";
      let lastOpenedText = "‚Äî";

      // =========================
      // TOAST
      // =========================
      let toastTimer = null;
      function toast(msg) {
        const wrap = $("toastWrap");
        const text = $("toastText");
        text.textContent = msg;
        wrap.classList.remove("hidden");
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => wrap.classList.add("hidden"), 1800);
      }

      // =========================
      // AUTH
      // =========================
      function getToken() {
        return localStorage.getItem("access"); // faqat token
      }

      async function authFetch(url, options = {}) {
        const token = getToken();
        if (!token) throw new Error("NO_TOKEN");

        const res = await fetch(url, {
          ...options,
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
            ...(options.headers || {}),
          },
        });

        if (res.status === 401 || res.status === 403)
          throw new Error("UNAUTHORIZED");
        return res;
      }

      // =========================
      // API LOADERS
      // =========================
      async function loadCoursesRaw() {
        const url = `${API_BASE}/courses/`;
        const res = await authFetch(url);

        const data = await res.json();

        // DRF pagination bo‚Äòlsa: data.results
        const list = Array.isArray(data)
          ? data
          : Array.isArray(data?.results)
          ? data.results
          : null;

        if (!res.ok) {
          console.error("COURSES HTTP ERROR", res.status, url, data);
          throw new Error("COURSES_BAD");
        }

        if (!list) {
          console.error("COURSES FORMAT ERROR", url, data);
          throw new Error("COURSES_NOT_ARRAY");
        }

        return list;
      }

      // =========================
      // MAP
      // =========================
      function mapLessonToUi(lesson) {
        const firstVideo = (lesson.videos || [])[0] || null;
        return {
          id: String(lesson.id ?? ""),
          title: lesson.title ?? "‚Äî",
          level: lesson.level ?? "‚Äî",
          duration: lesson.duration ?? "‚Äî",
          videoId: lesson.videoId ?? lesson.video_id ?? "",
          videoUrl: firstVideo
            ? firstVideo.video_url || firstVideo.video || ""
            : lesson.video_url || "",
          bullets: Array.isArray(lesson.bullets) ? lesson.bullets : [],
          task: lesson.task ?? lesson.content ?? "‚Äî",
          is_completed: false, // keyin progressdan qo'yamiz
          is_locked: false, // keyin computeLocks bilan qo'yamiz
        };
      }

      function mapCourseToUi(course) {
        return {
          id: String(course.id ?? ""),
          title: course.title ?? "‚Äî",
          badge: course.badge ?? "üìö",
          cover: course.cover ?? course.cover_url ?? course.cover_image ?? "",
          gradient:
            course.gradient ?? "from-slate-700 via-slate-800 to-slate-900",
          desc: course.desc ?? course.description ?? "‚Äî",
          tags: Array.isArray(course.tags) ? course.tags : [],
          progress_percent: 0,
          teacher: course.teacher_name ?? course.teacher ?? "RiseUp Academy",
          students: course.students ?? null,
          isFree: course.is_free ?? course.isFree ?? true,
          price: course.price ?? "",
          lessons: Array.isArray(course.lessons)
            ? course.lessons.map(mapLessonToUi)
            : [],
        };
      }

      // ‚úÖ progressni lessonsga yopishtirish
      function applyProgressToCourses(progressList) {
        // progressList: [{lesson: <id>, completed: true}, ...] yoki serializerdan kelgan format
        const completedSet = new Set(
          (progressList || [])
            .filter(
              (p) =>
                p &&
                (p.completed === true ||
                  p.completed === "true" ||
                  p.completed === 1)
            )
            .map((p) => String(p.lesson))
        );

        for (const c of DATA.directions) {
          for (const l of c.lessons) {
            l.is_completed = completedSet.has(String(l.id));
          }
        }
      }

      // ‚úÖ lock + percent
      function computeLocksAndProgress() {
        for (const c of DATA.directions) {
          const lessons = c.lessons || [];
          let completedCount = 0;

          for (let i = 0; i < lessons.length; i++) {
            const l = lessons[i];

            if (i === 0) l.is_locked = false;
            else l.is_locked = !lessons[i - 1].is_completed;

            if (l.is_completed) completedCount++;
          }

          c.progress_percent = lessons.length
            ? Math.round((completedCount / lessons.length) * 100)
            : 0;
        }
      }

      // ‚úÖ davom ettirish darsi: birinchi ochiq & tugallanmagan
      function findResumeLessonIdByProgress(course) {
        const lessons = course?.lessons || [];
        if (!lessons.length) return null;

        const next = lessons.find((l) => !l.is_locked && !l.is_completed);
        if (next) return next.id;

        return lessons[lessons.length - 1].id;
      }

      // =========================
      // HELPERS UI
      // =========================
      function jamiDarslarSoni() {
        return (DATA.directions || []).reduce(
          (sum, d) => sum + ((d.lessons || []).length || 0),
          0
        );
      }

      function yonalishTop(id) {
        return (DATA.directions || []).find((d) => d.id === id);
      }

      function darsTop(darsId) {
        for (const d of DATA.directions || []) {
          const idx = (d.lessons || []).findIndex((l) => l.id === darsId);
          if (idx !== -1)
            return { yonalish: d, index: idx, dars: d.lessons[idx] };
        }
        return null;
      }

      function setHash(path) {
        location.hash = path;
      }

      function viewKorsat(viewId) {
        ["viewYonalishlar", "viewDarslar", "viewPlayer"].forEach((v) =>
          $(v).classList.add("hidden")
        );
        $(viewId).classList.remove("hidden");
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function headerSync() {
        $("jamiYonalishlar").textContent = String(
          (DATA.directions || []).length
        );
        $("jamiDarslar").textContent = String(jamiDarslarSoni());
        $("oxirgiOchildi").textContent = lastOpenedText || "‚Äî";
      }

      // =========================
      // FILTER UI
      // =========================
      function getActiveFilter() {
        return activeFilter;
      }

      function setActiveFilter(key) {
        activeFilter = key;
        filterBarUpdateUI();
        yonalishlarRender();
      }

      function filterBarRender() {
        const bar = $("filterBar");
        const active = getActiveFilter();

        bar.innerHTML = FILTERS.map(
          (f) => `
          <button type="button" data-filter="${f.key}"
            class="rounded-full border px-4 py-2.5 text-sm font-semibold transition
              ${
                f.key === active
                  ? "border-sky-400/70 bg-sky-500/15 text-sky-200"
                  : "border-slate-700/70 bg-slate-900/60 text-slate-200 hover:bg-slate-800/60 hover:border-slate-600"
              }">
            ${f.label}
          </button>
        `
        ).join("");

        bar.querySelectorAll("button[data-filter]").forEach((btn) => {
          btn.addEventListener("click", () =>
            setActiveFilter(btn.dataset.filter)
          );
        });
      }

      function filterBarUpdateUI() {
        const active = getActiveFilter();
        const bar = $("filterBar");
        if (!bar) return;

        bar.querySelectorAll("button[data-filter]").forEach((btn) => {
          const on = btn.dataset.filter === active;
          btn.className =
            "rounded-full border px-4 py-2.5 text-sm font-semibold transition " +
            (on
              ? "border-sky-400/70 bg-sky-500/15 text-sky-200"
              : "border-slate-700/70 bg-slate-900/60 text-slate-200 hover:bg-slate-800/60 hover:border-slate-600");
        });
      }

      // =========================
      // RENDER
      // =========================
      function yonalishlarRender() {
        const grid = $("yonalishlarGrid");
        const filter = getActiveFilter();
        const q = ($("qidiruvInput").value || "").trim().toLowerCase();

        const list = (DATA.directions || []).filter((d) => {
          const matchFilter =
            filter === "all" ? true : (d.tags || []).includes(filter);
          const matchSearch = !q
            ? true
            : (d.title || "").toLowerCase().includes(q) ||
              (d.desc || "").toLowerCase().includes(q);
          return matchFilter && matchSearch;
        });

        grid.innerHTML = list
          .map((d) => {
            const lessonsCount = (d.lessons || []).length;
            const teacher = d.teacher || "RiseUp Academy";
            const students = d.students || null;
            const isFree = d.isFree ?? true;
            const priceText = isFree ? "Bepul" : d.price || "Premium";

            const cover =
              d.cover && String(d.cover).trim().length > 0 ? d.cover : null;
            const gradient =
              d.gradient || "from-slate-700 via-slate-800 to-slate-900";

            return `
              <button onclick="app.yonalishOch('${d.id}')"
                class="group text-left rounded-2xl border border-slate-700/70 bg-slate-900/55 overflow-hidden shadow-lg shadow-slate-950/70 hover:border-sky-400/60 hover:-translate-y-[2px] transition-all duration-200">
                <div class="relative h-44 overflow-hidden">
                  ${
                    cover
                      ? `<img src="${cover}" alt="${d.title}" class="absolute inset-0 w-full h-full object-cover scale-[1.03] group-hover:scale-[1.07] transition duration-300" onerror="this.style.display='none'">`
                      : ``
                  }
                  <div class="absolute inset-0 bg-gradient-to-br ${gradient} ${
              cover ? "opacity-55" : "opacity-95"
            }"></div>
                  <div class="absolute inset-0 opacity-[0.10] bg-grid bg-[length:22px_22px]"></div>
                  <div class="absolute inset-0 bg-slate-950/35"></div>
                  <div class="absolute inset-0 bg-gradient-to-t from-slate-950 via-slate-950/45 to-transparent"></div>
                  <div class="relative p-4 flex items-start justify-between">
                    <span class="inline-flex items-center gap-2 rounded-full border border-sky-400/25 bg-sky-500/10 px-3 py-1 text-[11px] font-extrabold text-sky-200">YO‚ÄòNALISH</span>
                    <span class="inline-flex items-center rounded-full border border-slate-200/10 bg-slate-950/35 px-3 py-1 text-[11px] font-bold text-slate-100">${priceText}</span>
                  </div>
                  <div class="relative px-4 pb-4 mt-6">
                    <h3 class="text-xl md:text-2xl font-extrabold text-white leading-tight">${
                      d.title
                    }</h3>
                    <div class="mt-2 flex items-center justify-between">
                      <p class="text-sm text-slate-200/90">${lessonsCount} ta dars</p>
                      <div class="text-2xl opacity-90 drop-shadow">${
                        d.badge || "üìö"
                      }</div>
                    </div>
                  </div>
                </div>

                <div class="p-5 space-y-4">
                  <p class="text-sm text-slate-200/85 leading-relaxed">${
                    d.desc || "‚Äî"
                  }</p>
                  <div class="flex items-center justify-between text-sm">
                    <div class="text-slate-400">
                      <span class="text-slate-300 font-semibold">${teacher}</span>
                      ${
                        students
                          ? `<span class="text-slate-500"> ¬∑ ${students} o‚Äòquvchi</span>`
                          : ``
                      }
                    </div>
                    <span class="text-slate-400">Progress</span>
                  </div>
                  <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm">
                      <span class="text-slate-300">Tugallangan</span>
                      <span class="font-extrabold text-sky-300">${
                        d.progress_percent ?? 0
                      }%</span>
                    </div>
                    <div class="h-2.5 rounded-full bg-slate-800/80 overflow-hidden">
                      <div class="h-full bg-gradient-to-r from-sky-400 to-indigo-500" style="width:${
                        d.progress_percent ?? 0
                      }%"></div>
                    </div>
                  </div>
                </div>
              </button>
            `;
          })
          .join("");

        if (list.length === 0) {
          grid.innerHTML = `
            <div class="sm:col-span-2 lg:col-span-3 bg-slate-900/60 border border-slate-700/70 rounded-2xl p-6 text-center">
              <p class="text-base font-extrabold text-slate-200">Hech narsa topilmadi</p>
              <p class="text-sm text-slate-400 mt-1">Filtr yoki qidiruvni o'zgartirib ko'ring.</p>
            </div>
          `;
        }
      }

      function darslarRender(yonalishId) {
        const d = yonalishTop(yonalishId);
        if (!d) return;

        $("yonalishTitle").textContent = d.title;
        $("yonalishDesc").textContent = d.desc;
        $("yonalishCount").textContent = String((d.lessons || []).length);

        const resumeId = findResumeLessonIdByProgress(d);
        $("btnBirinchiDars").textContent = "Davom ettirish ‚ñ∂Ô∏è";
        $("btnBirinchiDars").onclick = () => {
          if (!resumeId) return;
          setHash(`#/dars/${resumeId}`);
        };

        $("darslarList").innerHTML = (d.lessons || [])
          .map(
            (l, i) => `
              <button onclick="app.darsOch('${l.id}')"
                class="w-full text-left bg-slate-900/80 border border-slate-700/80 rounded-2xl p-5 shadow-lg shadow-slate-950/80 transition
                ${l.is_locked ? "opacity-70" : "hover:border-emerald-400/70"}">
                <div class="flex items-start justify-between gap-3">
                  <div class="space-y-1">
                    <p class="text-xs text-slate-400 uppercase tracking-[0.16em]">${
                      i + 1
                    }-dars</p>
                    <p class="text-lg font-extrabold text-white leading-snug">${
                      l.title
                    }</p>
                    <p class="text-sm text-slate-300">
                      Daraja: <span class="text-slate-100 font-semibold">${
                        l.level
                      }</span> ¬∑ ${l.duration}
                    </p>
                  </div>
                  <div class="flex flex-col items-end gap-2">
                    ${
                      l.is_locked
                        ? `<span class="text-xs font-extrabold px-3 py-1 rounded-full bg-slate-800/70 border border-slate-700/70 text-slate-200">üîí Qulflangan</span>`
                        : ``
                    }
                    ${
                      l.is_completed
                        ? `<span class="text-xs font-extrabold px-3 py-1 rounded-full bg-emerald-500/15 border border-emerald-400/40 text-emerald-200">‚úÖ Ko'rildi</span>`
                        : ``
                    }
                    <div class="text-2xl ${
                      l.is_locked ? "opacity-40" : ""
                    }">‚ñ∂Ô∏è</div>
                  </div>
                </div>
                ${
                  l.is_locked
                    ? `<p class="mt-4 text-sm text-slate-400">Avvalgi darsni ‚úÖ ko‚Äòrildi deb belgilang ‚Äî keyingi dars ochiladi.</p>`
                    : ``
                }
              </button>
          `
          )
          .join("");

        viewKorsat("viewDarslar");
      }

      function sidebarDarslarRender(yonalish, activeLessonId) {
        $("sidebarYonalishTitle").textContent = yonalish.title;
        const q = ($("darsQidiruv").value || "").trim().toLowerCase();
        const list = (yonalish.lessons || []).filter((l) =>
          !q ? true : (l.title || "").toLowerCase().includes(q)
        );

        $("sidebarDarslar").innerHTML = list
          .map((l, i) => {
            const active = l.id === activeLessonId;
            const base =
              "w-full text-left rounded-2xl border px-4 py-3 transition";
            const state = active
              ? "border-sky-400/70 bg-sky-500/10"
              : "border-slate-700/70 bg-slate-950/30 hover:bg-slate-900/70 hover:border-slate-600";

            return `
              <button onclick="app.darsOch('${
                l.id
              }')" class="${base} ${state} ${l.is_locked ? "opacity-60" : ""}">
                <div class="flex items-start justify-between gap-3">
                  <div class="min-w-0">
                    <p class="text-xs uppercase tracking-[0.16em] ${
                      active ? "text-sky-200" : "text-slate-400"
                    }">${i + 1}-dars</p>
                    <p class="text-sm font-extrabold ${
                      active ? "text-white" : "text-slate-200"
                    } truncate">${l.title}</p>
                    <p class="text-xs ${
                      active ? "text-sky-100/80" : "text-slate-400"
                    }">${l.level} ¬∑ ${l.duration}</p>
                    <div class="mt-2 flex flex-wrap gap-2">
                      ${
                        l.is_locked
                          ? `<span class="text-[11px] font-extrabold px-2 py-1 rounded-full bg-slate-800/70 border border-slate-700/70 text-slate-200">üîí Qulflangan</span>`
                          : ``
                      }
                      ${
                        l.is_completed
                          ? `<span class="text-[11px] font-extrabold px-2 py-1 rounded-full bg-emerald-500/15 border border-emerald-400/40 text-emerald-200">‚úÖ Ko'rildi</span>`
                          : ``
                      }
                    </div>
                  </div>
                  <span class="text-lg ${
                    active ? "text-sky-200" : "text-slate-400"
                  } ${l.is_locked ? "opacity-40" : ""}">‚ñ∂</span>
                </div>
              </button>
            `;
          })
          .join("");

        if (list.length === 0)
          $(
            "sidebarDarslar"
          ).innerHTML = `<div class="text-sm text-slate-400 px-3 py-4">Hech qanday dars topilmadi.</div>`;
      }

      function updateKorildiButtonState(isCompleted) {
        const btn = $("btnKorildi");
        if (!btn) return;

        if (isCompleted) {
          btn.textContent = "Saqlangan ‚úÖ";
          btn.classList.remove(
            "from-emerald-500",
            "to-teal-500",
            "hover:from-emerald-400",
            "hover:to-teal-400"
          );
          btn.classList.add("from-slate-600", "to-slate-500");
          btn.disabled = true;
        } else {
          btn.textContent = "‚úÖ Ko'rildi deb belgilash";
          btn.disabled = false;
          btn.classList.remove("from-slate-600", "to-slate-500");
          btn.classList.add(
            "from-emerald-500",
            "to-teal-500",
            "hover:from-emerald-400",
            "hover:to-teal-400"
          );
        }
      }

      async function saveProgress(lessonId, completed = true) {
        const idNum = Number(lessonId);
        if (!Number.isFinite(idNum)) throw new Error("LESSON_ID_NOT_NUMBER");

        const res = await authFetch(`${API_BASE}/lesson-progress/`, {
          method: "POST",
          body: JSON.stringify({ lesson: idNum, completed }),
        });

        if (!res.ok) throw new Error("PROGRESS_SAVE_FAILED");
        return res.json();
      }

      function playerRender(darsId) {
        const found = darsTop(darsId);
        if (!found) return;

        const { yonalish, index, dars } = found;

        if (dars.is_locked) {
          toast("üîí Bu dars yopiq. Avvalgi darsni ‚úÖ Ko‚Äòrildi deb belgilang.");
          setHash(`#/yonalish/${yonalish.id}`);
          return;
        }

        $("playerBreadcrumb").textContent = `Yo'nalish: ${yonalish.title} ¬∑ ${
          index + 1
        }/${(yonalish.lessons || []).length}`;
        $("darsTitle").textContent = dars.title;
        $(
          "darsMeta"
        ).textContent = `Daraja: ${dars.level} ¬∑ Davomiyligi: ${dars.duration}`;

        lastOpenedText = `${yonalish.title}: ${dars.title}`;
        headerSync();

        updateKorildiButtonState(!!dars.is_completed);

        const ytFrame = $("ytFrame");
        const videoPlayer = $("videoPlayer");

        if (dars.videoUrl) {
          ytFrame.src = "";
          ytFrame.classList.add("hidden");
          videoPlayer.classList.remove("hidden");
          videoPlayer.src = dars.videoUrl;
        } else {
          try {
            videoPlayer.pause();
          } catch {}
          videoPlayer.removeAttribute("src");
          videoPlayer.classList.add("hidden");
          ytFrame.classList.remove("hidden");
          ytFrame.src = `https://www.youtube-nocookie.com/embed/${dars.videoId}?rel=0&modestbranding=1`;
        }

        $("darsBullets").innerHTML = (dars.bullets || [])
          .map((x) => `<li>${x}</li>`)
          .join("");
        $("darsTask").textContent = dars.task || "‚Äî";

        $("btnOldingi").disabled = index === 0;
        $("btnKeyingi").disabled =
          index === (yonalish.lessons || []).length - 1;

        $("btnOldingi").onclick = () => {
          if (index > 0) setHash(`#/dars/${yonalish.lessons[index - 1].id}`);
        };
        $("btnKeyingi").onclick = () => {
          if (index < (yonalish.lessons || []).length - 1)
            setHash(`#/dars/${yonalish.lessons[index + 1].id}`);
        };

        $("btnKorildi").onclick = async () => {
          try {
            await saveProgress(dars.id, true);

            // ‚úÖ progressni backenddan qayta olib kelamiz
            const [rawCourses, rawProgress] = await Promise.all([
              loadCoursesRaw(),
              loadProgressRaw(),
            ]);
            DATA = { directions: rawCourses.map(mapCourseToUi) };
            applyProgressToCourses(rawProgress);
            computeLocksAndProgress();

            const again = darsTop(String(darsId));
            if (again) {
              updateKorildiButtonState(true);
              sidebarDarslarRender(again.yonalish, again.dars.id);
            }

            headerSync();
            yonalishlarRender();
            toast("‚úÖ Saqlandi! Keyingi dars ochildi.");
          } catch (e) {
            toast("‚ùå Progress saqlanmadi: " + e.message);
          }
        };

        $("darsQidiruv").value = "";
        sidebarDarslarRender(yonalish, dars.id);
        $("darsQidiruv").oninput = () =>
          sidebarDarslarRender(yonalish, dars.id);

        viewKorsat("viewPlayer");
      }

      // =========================
      // ROUTER
      // =========================
      function route() {
        const h = location.hash || "#/";
        if (h === "#/" || h === "#") return viewKorsat("viewYonalishlar");

        const m1 = h.match(/^#\/yonalish\/([a-z0-9-]+)$/i);
        if (m1) return darslarRender(m1[1]);

        const m2 = h.match(/^#\/dars\/([a-z0-9-]+)$/i);
        if (m2) return playerRender(m2[1]);

        viewKorsat("viewYonalishlar");
      }

      window.app = {
        yonalishOch(id) {
          setHash(`#/yonalish/${id}`);
        },
        darsOch(id) {
          const found = darsTop(String(id));
          if (!found) return;
          if (found.dars.is_locked) {
            toast(
              "üîí Bu dars yopiq. Avvalgi darsni ‚úÖ Ko‚Äòrildi deb belgilang."
            );
            return;
          }
          setHash(`#/dars/${found.dars.id}`);
        },
      };

      function navSetup() {
        $("btnBoshSahifa").onclick = () => setHash("#/");
        $("btnOrqaga").onclick = () => {
          const h = location.hash || "#/";
          if (h.startsWith("#/dars/")) {
            const found = darsTop((h.match(/^#\/dars\/(.+)$/) || [])[1] || "");
            if (found) return setHash(`#/yonalish/${found.yonalish.id}`);
            return setHash("#/");
          }
          if (h.startsWith("#/yonalish/")) return setHash("#/");
          setHash("#/");
        };
      }

      // =========================
      // INIT
      // =========================
      async function init() {
        try {
          const [rawCourses, rawProgress] = await Promise.all([
            loadCoursesRaw(),
            loadProgressRaw(),
          ]);
          DATA = { directions: rawCourses.map(mapCourseToUi) };

          // ‚úÖ progressni qo'sh
          applyProgressToCourses(rawProgress);
          // ‚úÖ lock va percentni hisobla
          computeLocksAndProgress();
        } catch (e) {
          if (
            String(e.message) === "NO_TOKEN" ||
            String(e.message) === "UNAUTHORIZED"
          ) {
            window.location.href = "login.html";
            return;
          }
          toast("‚ùå API muammo: courses/progress ishlamayapti");
          DATA = { directions: [] };
        }

        headerSync();
        navSetup();

        filterBarRender();
        $("qidiruvInput").addEventListener("input", yonalishlarRender);

        yonalishlarRender();

        window.addEventListener("hashchange", () => {
          route();
        });

        route();
      }

      if (document.readyState === "loading")
        document.addEventListener("DOMContentLoaded", init);
      else init();
    </script>
  </body>
</html>
