<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Statistika ‚Ä¢ RiseUp</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          backgroundImage: {
            'grid': 'radial-gradient(circle at 1px 1px, rgba(148,163,184,0.18) 1px, transparent 0)',
          }
        }
      }
    }
  </script>
<style>
      html, body { overflow-x: hidden; }
      img, video, iframe { max-width: 100%; }
</style>
  <link rel="stylesheet" href="base.css" />
</head>
<body class="min-h-screen bg-slate-950 text-slate-50 font-sans antialiased">

  <!-- GLOBAL BACKGROUND -->
  <div class="pointer-events-none fixed inset-0 -z-30 bg-slate-950"></div>

  <div class="pointer-events-none fixed inset-0 -z-20 overflow-hidden">
    <div class="absolute -top-40 -left-10 h-80 w-80 rounded-full bg-indigo-500/35 blur-3xl"></div>
    <div class="absolute -bottom-40 -right-10 h-96 w-96 rounded-full bg-fuchsia-500/35 blur-3xl"></div>
    <div class="absolute inset-0 opacity-[0.07] bg-grid bg-[length:26px_26px]"></div>
  </div>

  <div class="pointer-events-none fixed inset-x-0 top-20 -z-10 flex justify-center">
    <div class="h-64 w-[650px] rounded-[999px] bg-gradient-to-r from-indigo-500/40 via-sky-400/40 to-fuchsia-400/40 blur-3xl opacity-70"></div>
  </div>
  <!-- END GLOBAL BACKGROUND -->

  <main class="relative max-w-6xl mx-auto px-6 py-10 space-y-8">

    <!-- TITLE / HEADER -->
    <header class="flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="h-11 w-11 rounded-2xl bg-gradient-to-br from-indigo-500 to-sky-400 flex items-center justify-center shadow-lg shadow-indigo-500/40">
          <span class="text-xl font-bold text-white">üìä</span>
        </div>
        <div>
          <h1 class="text-xl md:text-2xl font-semibold text-slate-50 tracking-tight">
            Statistika paneli
          </h1>
          <p class="text-sm text-slate-400">
            Ballaringiz, to‚Äòg‚Äòri/noto‚Äòg‚Äòri javoblaringiz va umumiy muvaffaqiyat darajasi.
          </p>
        </div>
      </div>
      <button onclick="refreshStats()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-medium transition-colors">
        Yangilash
      </button>
    </header>

    <!-- STATS GRID -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-5">
      <!-- Jami Balllar -->
      <div class="rounded-2xl border border-slate-800/70 bg-slate-900/70 backdrop-blur-xl p-4 sm:p-5 shadow-xl shadow-slate-950/60">
        <div class="flex items-center justify-between mb-2">
          <div>
            <p class="text-xs uppercase tracking-[0.14em] text-slate-400 font-semibold">Jami balllar</p>
            <p class="mt-2 text-3xl md:text-4xl font-bold text-indigo-400" id="totalPoints">0</p>
          </div>
          <div class="h-12 w-12 rounded-2xl bg-indigo-500/20 flex items-center justify-center text-2xl">
            ‚≠ê
          </div>
        </div>
        <p class="text-xs text-slate-500">
          Savollarga javob berib olgan umumiy balllaringiz.
        </p>
      </div>

      <!-- To'g'ri javoblar -->
      <div class="rounded-2xl border border-emerald-700/70 bg-emerald-950/50 backdrop-blur-xl p-4 sm:p-5 shadow-xl shadow-emerald-900/70">
        <div class="flex items-center justify-between mb-2">
          <div>
            <p class="text-xs uppercase tracking-[0.14em] text-emerald-300/80 font-semibold">
              To‚Äòg‚Äòri javoblar
            </p>
            <p class="mt-2 text-3xl md:text-4xl font-bold text-emerald-400" id="correctAnswers">0</p>
          </div>
          <div class="h-12 w-12 rounded-2xl bg-emerald-500/15 flex items-center justify-center text-2xl">
            ‚úÖ
          </div>
        </div>
        <p class="text-xs text-emerald-100/70">
          To‚Äòg‚Äòri belgilangan javoblar soni.
        </p>
      </div>

      <!-- Noto'g'ri javoblar -->
      <div class="rounded-2xl border border-rose-800/70 bg-rose-950/60 backdrop-blur-xl p-4 sm:p-5 shadow-xl shadow-rose-900/70">
        <div class="flex items-center justify-between mb-2">
          <div>
            <p class="text-xs uppercase tracking-[0.14em] text-rose-200/80 font-semibold">
              Noto‚Äòg‚Äòri javoblar
            </p>
            <p class="mt-2 text-3xl md:text-4xl font-bold text-rose-400" id="incorrectAnswers">0</p>
          </div>
          <div class="h-12 w-12 rounded-2xl bg-rose-500/20 flex items-center justify-center text-2xl">
            ‚ö†Ô∏è
          </div>
        </div>
        <p class="text-xs text-rose-100/80">
          Xatolar orqali ham o‚Äòrganamiz ‚Äì bu ham progress.
        </p>
      </div>

      <!-- Muvaffaqiyat foizi -->
      <div class="rounded-2xl border border-sky-700/70 bg-sky-950/60 backdrop-blur-xl p-4 sm:p-5 shadow-xl shadow-sky-900/70">
        <div class="flex items-center justify-between mb-2">
          <div>
            <p class="text-xs uppercase tracking-[0.14em] text-sky-200/80 font-semibold">
              Muvaffaqiyat darajasi
            </p>
            <p class="mt-2 text-3xl md:text-4xl font-bold text-sky-300" id="successRate">0%</p>
          </div>
          <div class="h-12 w-12 rounded-2xl bg-sky-500/20 flex items-center justify-center text-2xl">
            üìà
          </div>
        </div>
        <p class="text-xs text-sky-100/80">
          To‚Äòg‚Äòri javoblaringiz ulushi (%).
        </p>
      </div>
    </section>

    <!-- CHART SECTION -->
    <section class="rounded-2xl border border-slate-800/70 bg-slate-900/70 backdrop-blur-xl p-6 md:p-7 shadow-2xl shadow-slate-950/70 mt-4">
      <div class="flex items-center justify-between gap-3 mb-4">
        <div>
          <h2 class="text-lg md:text-xl font-semibold text-slate-50">
            Ball qo‚Äòshilishi grafigi
          </h2>
          <p class="text-xs text-slate-400">
            O‚Äòtgan vaqt mobaynida qanday qilib ball yig‚Äòganingizni ko‚Äòrsatadi.
          </p>
        </div>
        <div id="statsStatus" class="text-sm text-slate-400">
          Yuklanmoqda...
        </div>
      </div>

      <!-- Chart wrapper -->
      <div class="mt-6 h-[320px] md:h-[420px]">
        <canvas id="pointsChart"></canvas>
      </div>
    </section>
  </main>


  <script>
  let pointsChart = null;

  // === –û–ë–ù–û–í–õ–ï–ù–ò–ï –¢–û–ö–ï–ù–ê ===
  async function refreshToken() {
      try {
          const refresh = localStorage.getItem('refresh');
          if (!refresh) {
              window.location.href = 'login.html';
              return false;
          }

          const response = await fetch('http://127.0.0.1:8000/api/auth/refresh/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ refresh })
          });

          if (!response.ok) {
              window.location.href = 'login.html';
              return false;
          }

          const data = await response.json();
          localStorage.setItem('access', data.access);
          return true;
      } catch (error) {
          console.error('Token refresh failed:', error);
          window.location.href = 'login.html';
          return false;
      }
  }

  // === –ó–ê–ì–†–£–ó–ö–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò ===
  async function getUserStats() {
    try {
        const token = localStorage.getItem('access');
        if (!token) {
            throw new Error("Foydalanuvchi avtorizatsiyadan o'tmagan");
        }

        console.log("=== MAKING API REQUEST ===");
        console.log("Token exists:", !!token);
        console.log("Request URL: http://127.0.0.1:8000/api/stats/");
        
        const startTime = Date.now();
        const response = await fetch('http://127.0.0.1:8000/api/stats/', {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            }
        });

        const endTime = Date.now();
        console.log(`Request took: ${endTime - startTime}ms`);
        console.log("Response status:", response.status);
        console.log("Response status text:", response.statusText);
        console.log("Response headers:", Object.fromEntries(response.headers.entries()));
        
        // –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç
        const responseText = await response.text();
        console.log("Response text:", responseText);
        
        let data;
        try {
            data = JSON.parse(responseText);
            console.log("Parsed JSON data:", data);
        } catch (parseError) {
            console.error("Failed to parse JSON:", parseError);
            throw new Error(`Invalid JSON response: ${responseText.substring(0, 100)}...`);
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–∫–∏ –≤ –¥–∞–Ω–Ω—ã—Ö
        if (data.error) {
            console.warn("API returned with error field:", data.error);
            console.warn("Error message:", data.message);
            // –í—Å–µ —Ä–∞–≤–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ, –æ–Ω–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        }
        
        return data;

    } catch (error) {
        console.error("CRITICAL ERROR in getUserStats:", error);
        console.error("Error stack:", error.stack);
        throw error;
    }
}

  // === –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê ===
  function setStatus(text) {
      const el = document.getElementById("statsStatus");
      if (el) {
          el.textContent = text;
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç–∞—Ç—É—Å
          if (text.includes("‚úÖ") || text.includes("‚ùå") || text.includes("Yuklandi")) {
              setTimeout(() => {
                  el.textContent = "";
              }, 3000);
          }
      }
  }

  // === –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ===
  function updateUI(data) {
      if (!data) {
          setStatus("Ma'lumotlar yo'q ‚ùå");
          return;
      }

      // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞ API
      const points = data.user_stats?.total_points || 0;
      const correct = data.answers?.correct || 0;
      const incorrect = data.answers?.wrong || 0;
      const accuracy = data.user_stats?.success_rate || data.answers?.accuracy || 0;

      // –û–±–Ω–æ–≤–ª—è–µ–º DOM —ç–ª–µ–º–µ–Ω—Ç—ã
      document.getElementById("totalPoints").textContent = points;
      document.getElementById("correctAnswers").textContent = correct;
      document.getElementById("incorrectAnswers").textContent = incorrect;
      document.getElementById("successRate").textContent = `${Math.round(accuracy)}%`;

      // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
      createChart(data);
  }

  // === –°–û–ó–î–ê–ù–ò–ï –ì–†–ê–§–ò–ö–ê ===
  function createChart(data) {
      const ctx = document.getElementById('pointsChart').getContext('2d');
      
      // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
      if (pointsChart) {
          pointsChart.destroy();
      }

      const points = data.user_stats?.total_points || 0;
      const chartData = [];
      const chartLabels = [];

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –¥–∞—Ç–∞–º –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
      if (data.tasks?.by_date && data.tasks.by_date.length > 0) {
          const tasksByDate = data.tasks.by_date;
          
          // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
          tasksByDate.sort((a, b) => new Date(a.created_at__date) - new Date(b.created_at__date));
          
          // –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ–µ —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º 10 –±–∞–ª–ª–æ–≤ –∑–∞ –∑–∞–¥–∞–Ω–∏–µ)
          let cumulativePoints = 0;
          tasksByDate.forEach((item, index) => {
              cumulativePoints += item.count * 10;
              chartData.push(cumulativePoints);
              
              // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
              const date = new Date(item.created_at__date);
              const day = date.getDate();
              const month = date.getMonth() + 1;
              chartLabels.push(`${day < 10 ? '0' : ''}${day}.${month < 10 ? '0' : ''}${month}`);
          });
      } else {
          // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–∞—Ç–∞–º, —Å–æ–∑–¥–∞–µ–º –ª–∏–Ω–µ–π–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å
          const steps = Math.min(10, Math.max(3, Math.ceil(points / 20)));
          for (let i = 0; i <= steps; i++) {
              const progress = i / steps;
              chartData.push(Math.round(points * progress));
              chartLabels.push(`Qadam ${i + 1}`);
          }
      }

      const maxPoints = Math.max(points, 50); // –ú–∏–Ω–∏–º—É–º 50 –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏

      pointsChart = new Chart(ctx, {
          type: 'line',
          data: {
              labels: chartLabels,
              datasets: [{
                  label: 'Ball',
                  data: chartData,
                  fill: true,
                  backgroundColor: 'rgba(99,102,241,0.16)',
                  borderColor: '#6366f1',
                  borderWidth: 2,
                  tension: 0.4,
                  pointBackgroundColor: '#6366f1',
                  pointRadius: 4,
                  pointHoverRadius: 6
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: { display: false },
                  tooltip: {
                      enabled: true,
                      backgroundColor: 'rgba(15,23,42,0.95)',
                      borderColor: '#4f46e5',
                      borderWidth: 1,
                      titleColor: '#e5e7eb',
                      bodyColor: '#cbd5f5',
                      padding: 10,
                      cornerRadius: 8
                  }
              },
              scales: {
                  x: {
                      ticks: {
                          color: '#94a3b8',
                          font: { size: 11 }
                      },
                      grid: {
                          color: 'rgba(148,163,184,0.24)',
                          drawBorder: false
                      }
                  },
                  y: {
                      beginAtZero: true,
                      max: maxPoints,
                      ticks: {
                          stepSize: Math.max(10, Math.ceil(maxPoints / 5)),
                          color: '#94a3b8',
                          font: { size: 11 }
                      },
                      grid: {
                          color: 'rgba(148,163,184,0.22)',
                          drawBorder: false
                      }
                  }
              }
          }
      });
  }

  // === –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò ===
  async function loadAndDisplayStats() {
      setStatus("Yuklanmoqda...");
      
      try {
          const stats = await getUserStats();
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∞ –≤ –æ—Ç–≤–µ—Ç–µ
          if (stats.error) {
              console.warn("API returned error but we continue:", stats.error);
          }
          
          updateUI(stats);
          setStatus("Yuklandi ‚úÖ");
          
      } catch (error) {
          console.error("Statistikani yuklab bo'lmadi:", error);
          setStatus("Xatolik yuz berdi ‚ùå");
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–ª–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–ª—É—á—à–µ —á–µ–º –Ω–∏—á–µ–≥–æ)
          updateUI({
              user_stats: { total_points: 0, success_rate: 0 },
              answers: { correct: 0, wrong: 0, total: 0, accuracy: 0 },
              tasks: { total: 0, by_type: [], by_category: [], by_date: [] }
          });
      }
  }

  // === –†–£–ß–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï ===
  function refreshStats() {
      if (pointsChart) {
          pointsChart.destroy();
          pointsChart = null;
      }
      loadAndDisplayStats();
  }

  // === –í–´–•–û–î –ò–ó –°–ò–°–¢–ï–ú–´ ===
  function logout() {
      localStorage.removeItem('access');
      localStorage.removeItem('refresh');
      localStorage.removeItem('username');
      window.location.href = 'login.html';
  }

  // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ===
  document.addEventListener('DOMContentLoaded', () => {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
      const token = localStorage.getItem('access');
      if (!token) {
          window.location.href = 'login.html';
          return;
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      loadAndDisplayStats();
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
      setInterval(() => {
          refreshStats();
      }, 2 * 60 * 1000);
  });
  </script>

  <script src="base.js"></script>
</body>
</html>