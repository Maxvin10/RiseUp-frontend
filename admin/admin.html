<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard â€¢ RiseUp</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: {
            brand: {
              50: '#eef2ff',
              100: '#e0e7ff',
              500: '#6366f1',
              600: '#4f46e5',
              700: '#4338ca',
            }
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    .glass-card {
      background: linear-gradient(180deg, rgba(5, 5, 5, 0.98), rgba(25, 106, 187, 0.96));
      border: 1px solid rgba(148,163,184,0.22);
      box-shadow: 0 18px 45px rgba(15,23,42,0.12);
      border-radius: 16px;
      backdrop-filter: blur(18px);
    }
    .glass-soft {
      background: rgba(2,6,23,0.55);
      border: 1px solid rgba(148,163,184,0.18);
      border-radius: 16px;
      backdrop-filter: blur(18px);
    }
    .chip {
      border-radius:999px; padding:2px 10px; font-size:11px; font-weight:600;
      display:inline-flex; align-items:center; gap:6px;
      border: 1px solid rgba(148,163,184,0.20);
    }
    .chip-dot { width:7px; height:7px; border-radius:999px; }
    .nav-active { background: rgba(148,163,184,0.12); color: #fff; }
    .nav-idle { color: rgba(226,232,240,0.72); }
    .nav-idle:hover { background: rgba(148,163,184,0.10); color: #fff; }
    .table-head { background: rgba(15,23,42,0.65); }
    .row-hover:hover { background: rgba(148,163,184,0.06); }
    #toast {
      position: fixed; right: 18px; bottom: 18px;
      padding: 10px 14px; border-radius: 999px;
      font-size: 13px; font-weight: 600;
      z-index: 9999; display: none;
      box-shadow: 0 18px 40px rgba(15,23,42,0.22);
      border: 1px solid rgba(148,163,184,0.25);
      background: rgba(2,6,23,0.9);
      color: #e2e8f0;
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-950 to-slate-900 text-slate-50">

<!-- background -->
<div class="pointer-events-none fixed inset-0 -z-10">
  <div class="absolute -top-32 -left-10 h-72 w-72 rounded-full bg-brand-500/30 blur-3xl"></div>
  <div class="absolute -bottom-40 -right-10 h-80 w-80 rounded-full bg-fuchsia-500/25 blur-3xl"></div>
  <div class="absolute inset-0 opacity-[0.06] bg-[radial-gradient(circle_at_1px_1px,#1f2937_1px,transparent_0)] bg-[length:22px_22px]"></div>
</div>

<div class="flex min-h-screen">

  <!-- SIDEBAR -->
  <aside class="hidden md:flex md:flex-col w-72 border-r border-slate-800/70 bg-slate-950/70 backdrop-blur-xl">
    <div class="px-5 pt-5 pb-4 flex items-center gap-3">
      <div class="w-11 h-11 rounded-2xl bg-gradient-to-br from-brand-500 to-indigo-700 flex items-center justify-center text-lg font-bold shadow-lg shadow-indigo-500/30">
        RU
      </div>
      <div class="min-w-0">
        <p class="text-sm font-semibold tracking-tight">RiseUp Admin</p>
        <p class="text-xs text-slate-400">Monitoring â€¢ Users â€¢ Tasks</p>
      </div>
    </div>

    <div class="px-5 pb-3">
      <div class="glass-soft p-3">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-[11px] uppercase tracking-[0.16em] text-slate-400">Status</p>
            <p id="apiStatusText" class="text-sm font-semibold mt-1">Checkingâ€¦</p>
          </div>
          <div id="apiStatusChip" class="chip bg-slate-900/30">
            <span class="chip-dot bg-slate-400"></span>
            <span class="text-slate-200">API</span>
          </div>
        </div>
        <p class="text-xs text-slate-400 mt-2">Admin token mavjud boâ€˜lsa panel ishlaydi.</p>
      </div>
    </div>

    <nav class="mt-2 flex-1 px-3 space-y-1 text-sm">
      <button data-view="dashboard" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-xl nav-active">
        <span>ğŸ“Š</span> <span>Dashboard</span>
      </button>
      <button data-view="users" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-xl nav-idle">
        <span>ğŸ‘¥</span> <span>Users</span>
      </button>
      <button data-view="tasks" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-xl nav-idle">
        <span>âœ…</span> <span>Tasks</span>
      </button>
      <button data-view="features" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-xl nav-idle">
        <span>âœ¨</span> <span>Admin Tools</span>
      </button>
    </nav>

  </aside>

  <!-- MAIN -->
  <main class="flex-1 flex flex-col">

    <!-- TOPBAR -->
    <header class="flex items-center justify-between px-4 md:px-8 py-4 border-b border-slate-800/70 bg-slate-950/70 backdrop-blur-xl">
      <div>
        <p class="text-[11px] uppercase tracking-[0.18em] text-sky-300/90 mb-1">Admin</p>
        <h1 class="text-lg md:text-xl font-semibold flex items-center gap-2">
          <span id="currentViewText">Dashboard</span>
          <span id="envLabel" class="hidden md:inline-flex chip bg-amber-400/10 text-amber-300">
            <span class="chip-dot bg-amber-300"></span>
            <span>DEV</span>
          </span>
        </h1>
        <p id="subTitleText" class="text-xs text-slate-400 mt-1">Realtime monitoring & boshqaruv</p>
      </div>

      <div class="flex items-center gap-2 md:gap-3 text-[11px]">
        <div class="chip bg-emerald-400/10 text-emerald-200">
          <span class="chip-dot bg-emerald-300 animate-pulse"></span>
          <span id="adminRoleLabel">Super admin</span>
        </div>

        <!-- realtime chip -->
        <div id="realtimeChip" class="hidden md:inline-flex chip bg-sky-400/10 text-sky-200">
          <span class="chip-dot bg-sky-300"></span>
          <span id="onlineUsersLabel">Online: â€”</span>
        </div>
      </div>
    </header>

    <section class="flex-1 px-4 md:px-8 py-6 space-y-6">

      <!-- DASHBOARD -->
      <div id="view-dashboard" class="view space-y-6">

        <!-- KPI -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="glass-card px-4 py-4 flex items-center justify-between">
            <div>
              <p class="text-[11px] uppercase tracking-wide text-slate-300/70">Jami foydalanuvchilar</p>
              <p id="statTotalUsers" class="text-2xl font-semibold mt-2">â€”</p>
              <p class="text-[11px] text-slate-300/60 mt-1">Registrations</p>
            </div>
            <span class="text-2xl">ğŸ‘¤</span>
          </div>

          <div class="glass-card px-4 py-4 flex items-center justify-between">
            <div>
              <p class="text-[11px] uppercase tracking-wide text-slate-300/70">Telegram ulanganlar</p>
              <p id="statTelegramUsers" class="text-2xl font-semibold mt-2">â€”</p>
              <p class="text-[11px] text-slate-300/60 mt-1">Linked users</p>
            </div>
            <span class="text-2xl">ğŸ¤–</span>
          </div>

          <div class="glass-card px-4 py-4 flex items-center justify-between">
            <div>
              <p class="text-[11px] uppercase tracking-wide text-slate-300/70">Jami tasks</p>
              <p id="statTotalTasks" class="text-2xl font-semibold mt-2">â€”</p>
              <p class="text-[11px] text-slate-300/60 mt-1">All tasks</p>
            </div>
            <span class="text-2xl">âœ…</span>
          </div>

          <div class="glass-card px-4 py-4 flex items-center justify-between">
            <div>
              <p class="text-[11px] uppercase tracking-wide text-slate-300/70">Bugungi rejalangan</p>
              <p id="statTodayTasks" class="text-2xl font-semibold mt-2">â€”</p>
              <p class="text-[11px] text-slate-300/60 mt-1">Scheduled today</p>
            </div>
            <span class="text-2xl">ğŸ“…</span>
          </div>
        </div>

        <!-- Realtime panel -->
        <div id="realtimePanel" class="hidden glass-soft p-5">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h2 class="text-base font-semibold">Realtime Monitoring</h2>
              <p class="text-xs text-slate-400 mt-1">Online users, requestlar, kechikishlar (API boâ€˜lsa).</p>
            </div>
            <div class="chip bg-slate-900/30 text-slate-200">
              <span class="chip-dot bg-slate-300"></span>
              <span id="realtimeUpdatedAt">updated: â€”</span>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
            <div class="glass-soft p-4">
              <p class="text-xs text-slate-400">Online users</p>
              <p id="rtOnline" class="text-2xl font-semibold mt-1">â€”</p>
            </div>
            <div class="glass-soft p-4">
              <p class="text-xs text-slate-400">Requests / min</p>
              <p id="rtRpm" class="text-2xl font-semibold mt-1">â€”</p>
            </div>
            <div class="glass-soft p-4">
              <p class="text-xs text-slate-400">DB latency (ms)</p>
              <p id="rtDb" class="text-2xl font-semibold mt-1">â€”</p>
            </div>
            <div class="glass-soft p-4">
              <p class="text-xs text-slate-400">Queue / pending</p>
              <p id="rtQueue" class="text-2xl font-semibold mt-1">â€”</p>
            </div>
          </div>

          <p class="text-[11px] text-slate-400 mt-4">
            âœ… Bu blok keyin backendga endpoint qoâ€˜shilganda avtomatik ishlaydi: <span class="text-slate-200">/api/admin/realtime/</span>
          </p>
        </div>

        <!-- quick actions -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="glass-soft p-5">
            <h3 class="text-sm font-semibold">Quick actions</h3>
            <p class="text-xs text-slate-400 mt-1">Eng koâ€˜p ishlatiladigan admin ishlar.</p>
            <div class="mt-4 flex flex-wrap gap-2">
              <button onclick="showView('users')" class="px-3 py-2 rounded-xl bg-slate-800/60 border border-slate-700 text-xs hover:bg-slate-800">
                ğŸ‘¥ Users
              </button>
              <button onclick="showView('tasks')" class="px-3 py-2 rounded-xl bg-slate-800/60 border border-slate-700 text-xs hover:bg-slate-800">
                âœ… Tasks
              </button>
              <button onclick="loadDashboard(true)" class="px-3 py-2 rounded-xl bg-brand-600/20 border border-brand-500/40 text-xs hover:bg-brand-600/30">
                ğŸ”„ Refresh
              </button>
            </div>
          </div>

          <div class="glass-soft p-5 md:col-span-2">
            <h3 class="text-sm font-semibold">Admin notes (for your team)</h3>
            <p class="text-xs text-slate-400 mt-1">Bu yerga keyin â€œAnnouncementsâ€ qoâ€˜shsak boâ€˜ladi.</p>
            <ul class="mt-3 text-xs text-slate-300/80 space-y-2">
              <li>â€¢ Task yuborish (send_tasks) serverda worker boâ€˜lib ishlashi kerak.</li>
              <li>â€¢ Telegram bot + Backend bir xil env bilan ishlasin (BOT_TOKEN, API_BASE).</li>
              <li>â€¢ Supabase pooler ishlatilsa, connection limits va idle timeout tekshirilsin.</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- USERS -->
      <div id="view-users" class="view hidden space-y-4">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
          <div>
            <h2 class="text-base md:text-lg font-semibold">Users</h2>
            <p class="text-xs text-slate-400">Jami RiseUp foydalanuvchilari.</p>
          </div>

          <div class="flex items-center gap-2 w-full md:w-auto">
            <input id="userSearch" type="text" placeholder="Search by username or email..."
              class="w-full md:w-80 px-3 py-2 rounded-xl bg-slate-900/60 border border-slate-700 text-xs placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-sky-400" />
            <button onclick="loadUsers(document.getElementById('userSearch').value)"
              class="px-3 py-2 rounded-xl bg-slate-800/60 border border-slate-700 text-xs hover:bg-slate-800">
              ğŸ” Search
            </button>
          </div>
        </div>

        <div class="glass-soft overflow-hidden">
          <div class="overflow-x-auto">
            <table class="min-w-full text-xs">
              <thead class="table-head text-slate-200/90">
                <tr>
                  <th class="text-left py-3 px-3">ID</th>
                  <th class="text-left py-3 px-3">Username</th>
                  <th class="text-left py-3 px-3">Email</th>
                  <th class="text-left py-3 px-3">Role</th>
                  <th class="text-left py-3 px-3">Telegram</th>
                  <th class="text-left py-3 px-3">Tasks</th>
                  <th class="text-left py-3 px-3">Created</th>
                  <th class="text-left py-3 px-3">Last login</th>
                  <th class="text-right py-3 px-3">Action</th>
                </tr>
              </thead>
              <tbody id="usersTbody" class="divide-y divide-slate-800/60 bg-slate-950/30"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TASKS -->
      <div id="view-tasks" class="view hidden space-y-4">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
          <div>
            <h2 class="text-base md:text-lg font-semibold">Tasks</h2>
            <p class="text-xs text-slate-400">Filter: sent status + date.</p>
          </div>

          <div class="flex flex-wrap items-center gap-2 text-xs">
            <select id="taskSentFilter"
              class="px-3 py-2 rounded-xl bg-slate-900/60 border border-slate-700 text-xs focus:outline-none focus:ring-1 focus:ring-sky-400">
              <option value="">Sent: hammasi</option>
              <option value="false">Yuborilmagan</option>
              <option value="true">Yuborilgan</option>
            </select>

            <input id="taskDateFilter" type="date"
              class="px-3 py-2 rounded-xl bg-slate-900/60 border border-slate-700 text-xs focus:outline-none focus:ring-1 focus:ring-sky-400" />

            <button onclick="loadTasks()"
              class="px-3 py-2 rounded-xl bg-slate-800/60 border border-slate-700 text-xs hover:bg-slate-800">
              ğŸ”„ Apply
            </button>
          </div>
        </div>

        <div class="glass-soft overflow-hidden">
          <div class="overflow-x-auto">
            <table class="min-w-full text-xs">
              <thead class="table-head text-slate-200/90">
                <tr>
                  <th class="text-left py-3 px-3">ID</th>
                  <th class="text-left py-3 px-3">User</th>
                  <th class="text-left py-3 px-3">Title</th>
                  <th class="text-left py-3 px-3">Type</th>
                  <th class="text-left py-3 px-3">Category</th>
                  <th class="text-left py-3 px-3">Scheduled</th>
                  <th class="text-left py-3 px-3">Sent</th>
                  <th class="text-right py-3 px-3">Action</th>
                </tr>
              </thead>
              <tbody id="tasksTbody" class="divide-y divide-slate-800/60 bg-slate-950/30"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- FEATURES / ADMIN TOOLS -->
      <div id="view-features" class="view hidden space-y-4">
        <div class="glass-soft p-5">
          <h2 class="text-base md:text-lg font-semibold">Admin Tools (RiseUp uchun gâ€˜oyalar)</h2>
          <p class="text-xs text-slate-400 mt-1">Keyin qoâ€˜shsak admin panel real â€œstartup panelâ€ boâ€˜ladi.</p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-xs">
            <div class="glass-soft p-4">
              <p class="font-semibold">ğŸ†• Announcements</p>
              <p class="text-slate-400 mt-1">Saytga â€œyangilikâ€ card chiqishi, admin paneldan qoâ€˜shish/oâ€˜chirish.</p>
            </div>

            <div class="glass-soft p-4">
              <p class="font-semibold">ğŸ›¡ï¸ Audit log</p>
              <p class="text-slate-400 mt-1">Admin kimni oâ€˜chirdi, nima update qildi â€” hammasi log boâ€˜lsin.</p>
            </div>

            <div class="glass-soft p-4">
              <p class="font-semibold">ğŸš¨ Rate limit / Abuse</p>
              <p class="text-slate-400 mt-1">Login bruteforce boâ€˜lsa bloklash / throttling holatini koâ€˜rsatish.</p>
            </div>

            <div class="glass-soft p-4">
              <p class="font-semibold">ğŸ“Œ Task moderation</p>
              <p class="text-slate-400 mt-1">Notoâ€˜gâ€˜ri yoki spam tasklarni hide/delete/ban user.</p>
            </div>
          </div>
        </div>
      </div>

    </section>
  </main>
</div>

<div id="toast"></div>

<script>
/* ======================================================
   RISEUP ADMIN â€” CLEAN + PRO UI (keeps your logic)
   ====================================================== */

const API_BASE = 'http://127.0.0.1:8000/api/admin';
let dashboardInterval = null;
let realtimeInterval = null;

/* ==============================
   AUTH
   ============================== */

function hardLogout() {
  localStorage.removeItem('access');
  localStorage.removeItem('refresh');
  window.location.href = 'admin-login.html';
}

async function apiRequest(url, options = {}) {
  const token = localStorage.getItem('access');
  if (!token) {
    hardLogout();
    return { ok:false, status:401, data:null };
  }

  let res;
  try {
    res = await fetch(url, {
      ...options,
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
        ...(options.headers || {})
      }
    });
  } catch (e) {
    console.error('Network error:', e);
    return { ok:false, status:0, data:null };
  }

  if (res.status === 401 || res.status === 403) {
    hardLogout();
    return { ok:false, status:res.status, data:null };
  }

  if (res.status === 204) {
    return { ok:true, status:204, data:null };
  }

  let data = null;
  try { data = await res.json(); } catch {}

  return { ok: res.ok, status: res.status, data };
}

/* ==============================
   UI HELPERS
   ============================== */

function showToast(message) {
  const t = document.getElementById('toast');
  if (!t) return;
  t.textContent = message;
  t.style.display = 'block';
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(() => t.style.display = 'none', 2200);
}

function formatDateTime(str) {
  if (!str) return 'â€”';
  const d = new Date(str);
  return isNaN(d) ? str : d.toLocaleString();
}

function truncate(text, len = 40) {
  if (!text) return '';
  return text.length <= len ? text : text.slice(0, len) + 'â€¦';
}

function setSidebarStatus(ok) {
  const txt = document.getElementById('apiStatusText');
  const chip = document.getElementById('apiStatusChip');
  if (!txt || !chip) return;

  if (ok) {
    txt.textContent = 'Online';
    chip.className = 'chip bg-emerald-400/10 text-emerald-200';
    chip.innerHTML = `<span class="chip-dot bg-emerald-300 animate-pulse"></span><span>API</span>`;
  } else {
    txt.textContent = 'Offline';
    chip.className = 'chip bg-rose-400/10 text-rose-200';
    chip.innerHTML = `<span class="chip-dot bg-rose-300"></span><span>API</span>`;
  }
}

/* ==============================
   DASHBOARD
   ============================== */

async function loadDashboard(showToastOnOk=false) {
  const view = document.getElementById('view-dashboard');
  if (!view || view.classList.contains('hidden')) return;

  const elTotalUsers = document.getElementById('statTotalUsers');
  const elTelegram = document.getElementById('statTelegramUsers');
  const elTotalTasks = document.getElementById('statTotalTasks');
  const elTodayTasks = document.getElementById('statTodayTasks');

  const r = await apiRequest(`${API_BASE}/dashboard/`);
  setSidebarStatus(r.ok);

  if (!r.ok || !r.data) return;

  elTotalUsers.textContent = r.data.total_users ?? 'â€”';
  elTelegram.textContent = r.data.telegram_connected ?? 'â€”';
  elTotalTasks.textContent = r.data.total_tasks ?? 'â€”';
  elTodayTasks.textContent = r.data.today_tasks ?? 'â€”';

  // demo badge remove (optional)
  document.getElementById('envLabel')?.classList.add('hidden');

  if (showToastOnOk) showToast('Dashboard refreshed âœ…');
}

/* ==============================
   REALTIME (optional endpoint)
   expected: { online_users, rpm, db_latency_ms, queue_pending }
   ============================== */

async function loadRealtime() {
  const panel = document.getElementById('realtimePanel');
  const chip = document.getElementById('realtimeChip');
  const onlineLabel = document.getElementById('onlineUsersLabel');

  const r = await apiRequest(`${API_BASE}/realtime/`);
  if (!r.ok || !r.data) {
    // endpoint yo'q bo'lsa yashiramiz
    panel?.classList.add('hidden');
    chip?.classList.add('hidden');
    return;
  }

  panel?.classList.remove('hidden');
  chip?.classList.remove('hidden');

  document.getElementById('rtOnline').textContent = r.data.online_users ?? 'â€”';
  document.getElementById('rtRpm').textContent = r.data.rpm ?? 'â€”';
  document.getElementById('rtDb').textContent = r.data.db_latency_ms ?? 'â€”';
  document.getElementById('rtQueue').textContent = r.data.queue_pending ?? 'â€”';

  const now = new Date();
  document.getElementById('realtimeUpdatedAt').textContent = 'updated: ' + now.toLocaleTimeString();

  onlineLabel.textContent = `Online: ${r.data.online_users ?? 'â€”'}`;
}

/* ==============================
   USERS
   ============================== */

async function loadUsers(filter = '') {
  const tbody = document.getElementById('usersTbody');
  if (!tbody) return;

  const r = await apiRequest(`${API_BASE}/users/`);
  if (!r.ok || !r.data) return;

  const users = r.data;
  const q = (filter || '').toLowerCase();

  const filtered = users.filter(u =>
    (u.username || '').toLowerCase().includes(q) ||
    (u.email || '').toLowerCase().includes(q)
  );

  tbody.innerHTML = filtered.length
    ? filtered.map(u => `
        <tr class="row-hover">
          <td class="px-3 py-3">${u.id}</td>
          <td class="px-3 py-3">
            <div class="font-semibold">${u.username || 'â€”'}</div>
            <div class="text-[11px] text-slate-400">${u.is_staff ? 'Admin' : 'User'}</div>
          </td>
          <td class="px-3 py-3">${u.email || 'â€”'}</td>
          <td class="px-3 py-3">
            <span class="chip ${u.is_staff ? 'bg-amber-400/10 text-amber-200' : 'bg-slate-900/30 text-slate-200'}">
              <span class="chip-dot ${u.is_staff ? 'bg-amber-300' : 'bg-slate-300'}"></span>
              ${u.is_staff ? 'Admin' : 'User'}
            </span>
          </td>
          <td class="px-3 py-3">
            ${u.telegram_linked ? '<span class="chip bg-emerald-400/10 text-emerald-200"><span class="chip-dot bg-emerald-300"></span>Linked</span>' : '<span class="chip bg-rose-400/10 text-rose-200"><span class="chip-dot bg-rose-300"></span>â€”</span>'}
          </td>
          <td class="px-3 py-3">${u.tasks_count ?? 0}</td>
          <td class="px-3 py-3">${formatDateTime(u.created_at)}</td>
          <td class="px-3 py-3">${formatDateTime(u.last_login)}</td>
          <td class="px-3 py-3 text-right">
            <button
              onclick="deleteUser(${u.id}, '${(u.username || 'user').replace(/'/g,"\\'")}')"
              class="text-rose-300 hover:text-rose-200 text-xs font-semibold">
              Delete
            </button>
          </td>
        </tr>
      `).join('')
    : `<tr><td colspan="9" class="text-center py-6 text-slate-400">No users</td></tr>`;
}

/* ==============================
   DELETE USER (fix: 204 -> success)
   ============================== */

async function deleteUser(id, username) {
  const ok = confirm(`"${username}" userni oâ€˜chirasizmi?`);
  if (!ok) return;

  const r = await apiRequest(`${API_BASE}/users/${id}/`, { method: 'DELETE' });
  if (!r.ok) {
    showToast('Delete failed âŒ');
    return;
  }

  showToast('User deleted âœ…');
  loadUsers(document.getElementById('userSearch')?.value || '');
  loadDashboard();
}

/* ==============================
   TASKS
   ============================== */

async function loadTasks() {
  const tbody = document.getElementById('tasksTbody');
  if (!tbody) return;

  const sent = document.getElementById('taskSentFilter')?.value;
  const date = document.getElementById('taskDateFilter')?.value;

  const qs = new URLSearchParams();
  if (sent !== '') qs.append('sent', sent);
  if (date) qs.append('date', date);

  const r = await apiRequest(`${API_BASE}/tasks/?${qs}`);
  if (!r.ok || !r.data) return;

  const tasks = r.data;

  tbody.innerHTML = tasks.length
    ? tasks.map(t => `
        <tr class="row-hover">
          <td class="px-3 py-3">${t.id}</td>
          <td class="px-3 py-3">
            <div class="font-semibold">${t.user_username || 'â€”'}</div>
            <div class="text-[11px] text-slate-400">${t.user_email || 'â€”'}</div>
          </td>
          <td class="px-3 py-3">${truncate(t.title, 46)}</td>
          <td class="px-3 py-3">
            <span class="chip bg-slate-900/30 text-slate-200">
              <span class="chip-dot bg-slate-300"></span>
              ${t.type || 'â€”'}
            </span>
          </td>
          <td class="px-3 py-3">${t.category || 'â€”'}</td>
          <td class="px-3 py-3">${formatDateTime(t.scheduled_time)}</td>
          <td class="px-3 py-3">
            ${t.sent_to_telegram ? '<span class="chip bg-emerald-400/10 text-emerald-200"><span class="chip-dot bg-emerald-300"></span>Sent</span>' : '<span class="chip bg-amber-400/10 text-amber-200"><span class="chip-dot bg-amber-300"></span>Pending</span>'}
          </td>
          <td class="px-3 py-3 text-right">
            <button onclick="deleteTask(${t.id})" class="text-rose-300 hover:text-rose-200 text-xs font-semibold">
              Delete
            </button>
          </td>
        </tr>
      `).join('')
    : `<tr><td colspan="8" class="text-center py-6 text-slate-400">No tasks</td></tr>`;
}

async function deleteTask(id) {
  if (!confirm('Savolni oâ€˜chirasizmi?')) return;

  const r = await apiRequest(`${API_BASE}/tasks/${id}/`, { method: 'DELETE' });
  if (!r.ok) {
    showToast('Delete failed âŒ');
    return;
  }

  showToast('Task deleted âœ…');
  loadTasks();
  loadDashboard();
}

/* ==============================
   VIEW SWITCH
   ============================== */

function setNavActive(name) {
  document.querySelectorAll('.nav-btn').forEach(btn => {
    const isActive = btn.dataset.view === name;
    btn.classList.toggle('nav-active', isActive);
    btn.classList.toggle('nav-idle', !isActive);
  });
}

function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
  document.getElementById(`view-${name}`)?.classList.remove('hidden');

  setNavActive(name);

  const title = document.getElementById('currentViewText');
  const sub = document.getElementById('subTitleText');
  if (title) title.textContent = name.charAt(0).toUpperCase() + name.slice(1);
  if (sub) {
    sub.textContent =
      name === 'dashboard' ? 'Realtime monitoring & boshqaruv' :
      name === 'users' ? 'Users management, telegram link holati, statistikalar' :
      name === 'tasks' ? 'Task moderation, filter, scheduled & sent status' :
      'RiseUp admin feature gâ€˜oyalari va tools';
  }

  if (dashboardInterval) { clearInterval(dashboardInterval); dashboardInterval = null; }
  if (realtimeInterval) { clearInterval(realtimeInterval); realtimeInterval = null; }

  if (name === 'dashboard') {
    loadDashboard();
    dashboardInterval = setInterval(loadDashboard, 12000);

    // realtime (optional)
    loadRealtime();
    realtimeInterval = setInterval(loadRealtime, 7000);
  }

  if (name === 'users') loadUsers(document.getElementById('userSearch')?.value || '');
  if (name === 'tasks') loadTasks();
}

/* ==============================
   INIT
   ============================== */

document.addEventListener('DOMContentLoaded', async () => {
  // quick auth check
  const r = await apiRequest(`${API_BASE}/dashboard/`);
  setSidebarStatus(r.ok);

  if (!r.ok) return;

  document.getElementById('logoutBtn')?.addEventListener('click', hardLogout);

  document.getElementById('userSearch')?.addEventListener('input', e => loadUsers(e.target.value));
  document.getElementById('taskSentFilter')?.addEventListener('change', loadTasks);
  document.getElementById('taskDateFilter')?.addEventListener('change', loadTasks);

  document.querySelectorAll('.nav-btn')
    .forEach(btn => btn.addEventListener('click', () => showView(btn.dataset.view)));

  showView('dashboard');
});
</script>

</body>
</html>
